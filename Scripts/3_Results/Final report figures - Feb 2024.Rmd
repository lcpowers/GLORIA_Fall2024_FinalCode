---
title: "FinalReportFigs2"
author: "Claire Powers"
date: "2024-02-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Packages, data, models
```{r packages, include=FALSE}
rm(list=ls())

### Packages
library(tidyverse)
library(lme4)
library(corrplot)
library(ggthemes)
library(GGally)
library(ggfortify)
library(cowplot)
library(ggh4x)
library(ggpmisc)

## Color palettes ##
park.pal = c(GLAC='#B07AA1',YELL='#1170AA',ROMO='#59A14F',GRSD='#E6AB02',PECO='#C85200')
# colpal = c(gnp_col,ynp_col,rmn_col,gsd_col,pec_col)

# park.pal = viridis::viridis(n=5);scales::show_col(park.pal);names(park.pal)=c("GNP","YNP","RMN","GSD","PEC")

cover.pal3 = c(High = "#534666",Med = "#138086",Low="#DC8655")#;scales::show_col(cover.pal3)
# cover.pal3 = viridis::rocket(n=6)[c(2,3,5)];scales::show_col(cover.pal3)
names(cover.pal3) = c("High","Med","Low")

## Data ##
park2.order = c("GLAC","YELL","ROMO","GRSD","PECO")

###### Total vasc plant cover ######

### Read in and clean data
plantcover.us =read_csv('./AnalysisData/vascplantcover_final.csv') %>%
  filter(!is.na(start.plantCover)) %>%
  mutate(park2 = case_when(park=="GNP"~"GLAC",
                           park=="YNP"~"YELL",
                           park=="RMN"~"ROMO",
                           park=="GSD"~"GRSD",
                           park=="PEC"~"PECO"),
         PSaspect=paste(park,summit,aspect,sep="."),
         pchangecover = (change.cover/start.plantCover)*100) %>%
  relocate(c(change.cover,pchangecover),.after = end.plantCover) %>%
    arrange(-pchangecover) %>%
  filter(pchangecover<100) %>%
  mutate(park2 = factor(park2,levels=park2.order),
         tr.num = str_sub(transition,4,4))
# ### Create another dataframe where numeric predictor variables are scaled ###
plantcover.s = plantcover.us # Get names columns to standardize
scale_cols = plantcover.us %>% select(start.plantCover,climPC1,climPC2,sitelat,contains(c(".tmean",".aet",".pet",".ppt",".snowdays",".gdd"))) %>% names()
plantcover.s[scale_cols]=lapply(plantcover.s[scale_cols], function(x) scale(x))
##### End vasc plant cover #####

sppmodelvars = c("sciname","endcover","startcover","latmean1090","sitelat","climPC1","climPC2","habit","perenneating","transition","sciname","min.gdd","min.gs.ppt","min.wy.ppt","max.tmean","park")
sppcover.orig = read_csv('./AnalysisData/analysisdata_final.csv') %>% 
  mutate(park2 = case_when(park=="GNP"~"GLAC",
                           park=="YNP"~"YELL",
                           park=="RMN"~"ROMO",
                           park=="GSD"~"GRSD",
                           park=="PEC"~"PECO"))


sppcover.unscaled=sppcover.orig %>% 
  drop_na(startcover,climPC1,climPC2,latmax1090,latmin1090,latmean1090,latmedian1090) %>% 
  filter(abs(changecover)<=10) %>% # remove suspiciously large changes as these are likely associated with misIDed spp
  filter(startcover+endcover!=0) %>%  # remove cases where a species did not have start and end cover
  mutate(parksummit = paste(park,summit,sep="."),
         PSaspect = paste(park,summit,aspect,sep="."),
         startcovcats = cut(startcover,
                            breaks=c(-0.001,0,1,2,3,4,5,10,15,20,max(sppcover.orig$startcover)),
                            labels = c("0","0,1","1,2","2,3","3,4","4,5","5,10","10,15","15,20",">20"))) %>% 
  select(all_of(sppmodelvars),genus,changecover,aspect,summit,startyear,startcovcats,park2) %>% 
  mutate(park2 = factor(park2,levels=park2.order),
         tr.num = str_sub(transition,4,4))  

# Create another dataframe where numeric predictor variables are scaled
sppcover.scaled = sppcover.unscaled# Get names columns to standardize
scale_cols = sppcover.unscaled %>% select(startcover,climPC1,climPC2,sitelat,contains(c("1090",".tmean",".aet",".pet",".ppt",".snowdays",".gdd"))) %>% names()
sppcover.scaled[scale_cols]=lapply(sppcover.scaled[scale_cols], function(x) scale(x))
sppcover.scaled = sppcover.scaled %>% 
  mutate(startcover.unscaled=sppcover.unscaled$startcover,
         latmean1090.unscaled = sppcover.unscaled$latmean1090,
         sitelat.unscaled=sppcover.unscaled$sitelat)

sppcover.unscaled$changecover = sppcover.unscaled$endcover-sppcover.unscaled$startcover
rm(scale_cols)

## Models ##
climPC.mod.str = "endcover ~ startcover*(climPC1 + latmean1090 + I(latmean1090^2) + sitelat) + climPC2*perenneating + habit*climPC1 + habit*sitelat + (1 | transition) + (climPC1 + climPC2 | sciname)"
climPC.mod.s = lmer(formula = climPC.mod.str, na.action = "na.fail", data = sppcover.scaled, REML = T)
climPC.mod.us = lmer(formula = climPC.mod.str, na.action = "na.fail", data = sppcover.unscaled, REML = T)

# Best explicit climate variable model
# model string
climVar.mod.str = "endcover ~ startcover*(latmean1090 + I(latmean1090^2) + min.gdd + min.gs.ppt + min.wy.ppt + sitelat) + habit*(min.gdd + sitelat) + perenneating*max.tmean + (1 | transition) + (max.tmean + min.wy.ppt + min.gs.ppt + min.gdd | sciname)"

# Refit with REML
climVar.mod.s = lmer(formula = climVar.mod.str, na.action = "na.fail", data = sppcover.scaled, REML = T)
climVar.mod.us = lmer(formula = climVar.mod.str, na.action = "na.fail", data = sppcover.unscaled, REML = T)
rm(climPC.mod.str,climVar.mod.str)

climPC.plantCover.mod.us = lmer(end.plantCover~start.plantCover*(climPC1+climPC2+sitelat) + park + (1|transition), na.action = "na.fail",data = na.omit(plantcover.us),REML = TRUE)

climVar.plantCover.mod.us = lmer(formula = end.plantCover ~ max.snowdays + mean.gs.ppt + min.wy.ppt + park + start.plantCover + max.snowdays:start.plantCover + mean.gs.ppt:start.plantCover + min.wy.ppt:start.plantCover + (1 | transition), data = plantcover.us, REML = FALSE, na.action = "na.fail")
```

## Figure 1. PRISM time series
```{r fig1_PRISM.TS}
d.soil.temps = read_csv("InputData/byClaire/dailyT_alldates.csv") %>% 
  # read_csv("InputData/byClaire/allparks_dailyT_2022-11-01.csv") %>%
  filter(!(park=="PEC"&date<"2016-07-10")) %>%
  filter(!(park=="YNP"&date>"2016-09-01"))

unique(d.soil.temps$year[d.soil.temps$park=="YNP"])

# Read in prism data
prism_files <- list.files("./InputData/climate/prism/", pattern = ".csv",full.names = T)
park.summit = select(plantcover.us,park,summit) %>% unique()
d.prism.temps = NULL
for(i in prism_files){
  summiti <- str_sub(string = basename(i),start = 1,end = 3)
  df <- read_csv(i,skip=10) %>%
    mutate(summit=summiti) %>%
    select(summit,date=Date,ppt="ppt (mm)",
           pr.tmean="tmean (degrees C)",
           pr.tmax="tmax (degrees C)",
           pr.tmin="tmin (degrees C)") %>%
    mutate(year=year(date),
           study.year = ifelse(year%in%d.soil.temps$year[d.soil.temps$summit==summiti],1,0)) %>% 
    merge(.,park.summit)
  d.prism.temps <- rbind(d.prism.temps,df)
  rm(df,i,summiti)
}
rm(prism_files)

d.prism.temps = d.prism.temps %>% 
  mutate(park2 = case_when(park=="GNP"~"GLAC",
                           park=="YNP"~"YELL",
                           park=="RMN"~"ROMO",
                           park=="GSD"~"GRSD",
                           park=="PEC"~"PECO"),
         park2 = factor(park2,levels=park2.order))

y.prism.temps <- d.prism.temps %>% 
  group_by(park2,year,study.year) %>% 
  summarize(tmean = mean(pr.tmean))

study.years = filter(y.prism.temps,study.year==1)

ggplot()+
  geom_point(data = y.prism.temps,aes(x=year,y=tmean,color=park2),alpha=0.75)+
  scale_color_manual(values=park.pal)+
  # geom_smooth(data = y.prism.temps,
  #                aes(x=year,y=tmean,linetype="1990-2021"),
  #                color="black",
  #                method="lm",
  #                size=1,
  #                se=F) +
  stat_poly_line(data = y.prism.temps,aes(x=year,y=tmean,color=park2,linetype="1990-2021"),color="red",se=F) +
  stat_poly_eq(data = y.prism.temps,mapping = aes(x=year,y=tmean),color="red",label.y=0.95) +
  # geom_smooth(data = study.years,
  #             aes(x=year,y=tmean,linetype="Study years"),
  #             color="black",size=1,method="lm",se=F) +
  stat_poly_line(data = study.years,aes(x=year,y=tmean,color=park2,linetype="Study years"),color="black",se=F) +
  stat_poly_eq(data = study.years,mapping = aes(x=year,y=tmean),color="black",label.y=0.9) +
  guides(color="none")+
  facet_wrap(~park2,ncol=5)+
  theme_bw(base_size=15)+
  scale_linetype_manual(values=c(2,1))+
  theme(axis.text.x=element_text(angle=45,hjust=1),
        legend.title = element_blank(),
        legend.text = element_text(size=14),
        legend.key.width = unit(1.3,"cm"),
        legend.position = "top",
        legend.direction = "vertical")+
  labs(x = "Year", y = "Mean annual temperature (C)\nPRISM data")

ggsave("Results/FinalFigures/figure1_PRISM_TS.png",dpi=300,h=6.5,w=10)
rm(y.prism.temps,d.prism.temps,d.soil.temps,study.years)
```

## Figure 2. PCA plot
```{r fig2_climpca}

pca_df = sppcover.orig %>% 
  drop_na(startcover,climPC1,climPC2,latmax1090,latmin1090,latmean1090,latmedian1090) %>% 
  filter(abs(changecover)<=10) %>% # remove suspiciously large changes as these are likely associated with misIDed spp
  filter(startcover+endcover!=0) %>% 
  select(park,park2,summit,aspect,transition,contains(c(".tmean",".snow",".gdd",".ppt",".pet",".aet"))) %>% 
  mutate(park2 = factor(park2,levels=park2.order))

climcols = select(pca_df,contains(c(".tmean",".snow",".gdd",".ppt",".pet",".aet"))) %>% names()

# PCA on climate cols of climdf
climpca = prcomp(pca_df[climcols],scale. = T)
  
# Plot PCA
autoplot(climpca,data=pca_df,
         frame=T,
         frame.alpha=0.1,
         loadings=TRUE,
         loadings.colour="grey50",
         loadings.label.colour="black",
         loadings.label=T,
         loadings.label.fontface="bold",
         loadings.label.repel=T,
         loadings.label.size=4,
         loadings.label.just=0, colour = 'park2')+
  scale_x_continuous(limits=c(-0.04,0.05))+
  scale_color_manual(values=park.pal)+
  scale_fill_manual(values=park.pal)+
  theme_classic(base_size = 16)+
  theme(legend.title = element_blank())
ggsave("Results/FinalFigures/figure2_pca.png",h=7,w=9,dpi=500)
rm(pca_df,climpca,climcols)
```

## Figure 3. Change cover ~ start cover cats for all

#### Figures 3 and 4 originally made by Dan
```{r DansFigs_3}
sppcover.unscaled2=sppcover.orig %>% 
  drop_na(startcover,climPC1,climPC2,latmax1090,latmin1090,latmean1090,latmedian1090) %>% 
  filter(abs(changecover)<=20) %>% # remove suspiciously large changes as these are likely associated with misIDed spp
  filter(startcover+endcover!=0) %>%  # remove cases where a species did not have start and end cover
  mutate(parksummit = paste(park,summit,sep="."),
         PSaspect = paste(park,summit,aspect,sep="."),
         startcovcats = cut(startcover,
                            breaks=c(-0.001,0,1,2,3,4,5,10,15,20,max(sppcover.orig$startcover)),
                            labels = c("0","0,1","1,2","2,3","3,4","4,5","5,10","10,15","15,20",">20"))) %>% 
  select(all_of(sppmodelvars),genus,changecover,aspect,summit,startyear,startcovcats,park2) %>% 
  mutate(park2 = factor(park2,levels=park2.order),
         tr.num = str_sub(transition,4,4))  

ggplot(sppcover.unscaled2,aes(x=startcovcats,y=changecover))+
  geom_hline(yintercept = 0,color="black")+
  stat_boxplot(geom="errorbar")+
  geom_boxplot(fill="grey80",
               outlier.size = 1)+
  scale_y_continuous(breaks=seq(-15,15,5))+
  theme_bw(base_size = 14)+
  labs(x="Starting cover",y="Change in cover")+
  theme(panel.grid = element_blank())
ggsave("Results/FinalFigures/figure3_boxPlots.png",h=6,w=10,dpi=400)

```

## Figure 4. Change cover ~ start cover cats by park
```{r DansFigs_4}

ggplot(sppcover.unscaled2,aes(x=startcovcats,y=changecover))+
  geom_hline(yintercept = 0,color="black")+
  stat_boxplot(geom="errorbar")+
  geom_boxplot(fill="grey80",
               outlier.size = 1)+
  #scale_y_continuous(breaks=seq(-15,15,5))+
  theme_bw(base_size = 14)+
  labs(x="Starting cover",y="Change in cover")+
  theme(panel.grid = element_blank(),
        strip.background = element_rect(fill="grey95"),
        strip.text = element_text(face="bold"))+
  facet_wrap(~park2,ncol=2,scales="free_y")
ggsave("Results/FinalFigures/figure4_boxPlots_byPark.png",h=8,w=10,dpi=400)
# dev.off()
```

## Figures 5 & 6. Climvar correlations. Finished in powerpoint
```{r fig5_6_climvarCors}
climpc_df = select(sppcover.unscaled,park,summit,aspect,climPC1,climPC2,year=startyear)

### Plots of daily data? ###
clim.df = read_csv("InputData/byClaire/annualClim_for_plots.csv") %>% 
  mutate(park2 = case_when(park=="GNP"~"GLAC",
                           park=="YNP"~"YELL",
                           park=="RMN"~"ROMO",
                           park=="GSD"~"GRSD",
                           park=="PEC"~"PECO")) %>% 
  select(-sitelong) %>% 
  merge(climpc_df,by=c("park","summit","aspect","year"),all.x=T) %>% 
  mutate(park = factor(park,levels=park.order)) %>% 
  unique() 

climVar.df = clim.df %>% select(`Site latitude`= sitelat,`gs.tmean`=mean.tmean,GDD,wy.ppt,gs.ppt=ppt,park) %>% 
  na.omit()
names(climVar.df)[1:5] = c("Site latitude","Growing season T", "GDD","Water year ppt","Growing season ppt")

park.legend = ggplot(clim.df,aes(x=sitelat,y=park,fill=park)) +
  geom_col() + 
  scale_fill_manual(values=park.pal)+
  theme_classic(base_size = 18)+
  theme(legend.title = element_blank())

park.legend = park.legend %>% GGally::grab_legend()
park.pal2 = park.pal
names(park.pal2)=NULL

GGally::ggpairs(climVar.df,columns = 1:5,
                diag="blank",
                lower = list(continuous="points"),
                upper = list(continuous=wrap(ggally_cor,color="white")),
                legend = park.legend,
                ggplot2::aes(colour=park,fill=park,alpha=0.75))+
  theme_bw(base_size = 16)+
  theme(strip.background = element_blank(),
        strip.text = element_blank(),
    panel.grid = element_blank())+
  scale_fill_manual(values=park.pal2)+
  scale_color_manual(values=park.pal2)
ggsave("Results/FinalFigures/figure5_climVarScatters.png",h=9,w=11,bg='transparent')

### Same but now for clim PCs
climPC.df = clim.df %>% select(`Site latitude`= sitelat,climPC1,climPC2,park) %>% 
  na.omit()

GGally::ggpairs(climPC.df,columns=1:3,
                diag="blank",
                lower = list(continuous="points"),
                upper = list(continuous=wrap(ggally_cor)),
                legend = park.legend,
                ggplot2::aes(colour=park,fill=park))+
  theme_bw(base_size = 16)+
  theme(strip.background = element_blank(),
        #strip.text = element_blank(),
    panel.grid = element_blank())+
  scale_fill_manual(values=park.pal2)+
  scale_color_manual(values=park.pal2)
ggsave("Results/FinalFigures/figure6_climPCScatters.png",h=9*3/5,w=11.5*3/5,bg='transparent')
rm(clim.df,climpc_df,climPC.df,park.pal2)
```

## Figure 7: clim PC model coefficients
```{r fig7_climPCmodcoefs}
climPC.plotdf = read_csv("./Results/FixedEffects/climPCfixedeffects_unscaled_formatted.csv") %>% 
  mutate(full.name = factor(full.name,levels=full.name)) %>% 
  mutate(estimate.lab = ifelse(!is.na(sig),paste0(round(estimate,3),sig),round(estimate,3)))

ggplot(climPC.plotdf,aes(x=estimate,y=full.name,color=estimate>0))+
  geom_vline(xintercept = 0,color="grey70",linetype="dashed")+
  geom_point(size=2) +
  geom_errorbar(aes(xmin=estimate-std.error*1.96,xmax=estimate+std.error*1.96),width=0.25)+
  geom_text(aes(y=full.name,label=estimate.lab),vjust=-0.75,fontface="bold",size=3.25)+
  theme_bw(base_size = 13)+
  labs(x = "Estimate", y = "")+
  theme(legend.position = "none",
        axis.title.y = element_blank())+
  coord_cartesian(xlim=c(-4,4))+
  scale_x_continuous(breaks=seq(-4,4,2))+
  scale_color_manual(values=c("red3","dodgerblue3"))+
  scale_y_discrete(limits=rev(levels(climPC.plotdf$full.name)),expand=c(0,1))
ggsave("Results/FinalFigures/figure7_climPC_FEforestplots_unscaled.png",dpi=300,h=8,w=10)
# rm(climPC.plotdf) 
```

## Figure 8: clim VAR model coefficients
```{r fig8_climVARmodcoefs}

climVar.plotdf = read_csv("Results/FixedEffects/climVarfixedeffects_unscaled_formatted.csv")%>% 
  mutate(full.name = factor(full.name,levels=full.name))

sjPlot::plot_model(climVar.mod.us,show.values = T,show.p = T)

ggplot(climVar.plotdf,aes(x=estimate,y=full.name,color=estimate>0))+
  geom_vline(xintercept = 0,color="grey70",linetype="dashed")+
  geom_point(size=2)+
  geom_errorbar(aes(xmin=estimate-std.error*1.96,xmax=estimate+std.error*1.96),width=0.25)+
  geom_text(aes(y=full.name,label=round(estimate,3)),vjust=-0.75,fontface="bold",size=3.25)+
  theme_bw(base_size = 13)+
  labs(x = "Estimate", y = "")+
  theme(legend.position = "none",
        axis.title.y = element_blank())+
  coord_cartesian(xlim=c(-2.25,2.25))+
  scale_color_manual(values=c("red3","dodgerblue3"))+
  scale_y_discrete(limits=rev(levels(climVar.plotdf$full.name)),expand=c(0,1))
ggsave("Results/FinalFigures/figure8_climVar_FEforestplots_unscaled.png",dpi=300,h=8,w=10)
rm(climVar.plotdf)
```

## Figure 9. Average model responses
```{r fig9_avgResponses}

startcover.range = seq(quantile(sppcover.unscaled$startcover[sppcover.unscaled$startcover>=0],0.01),
                       quantile(sppcover.unscaled$startcover[sppcover.unscaled$startcover>=0],0.95),
                       length.out=10)

pc_pred_df = expand.grid(startcover = startcover.range,
                      latmean1090 = median(sppcover.unscaled$latmean1090),
                      sitelat = median(sppcover.unscaled$sitelat),
                      climPC1 = median(sppcover.unscaled$climPC1),
                      climPC2 = median(sppcover.unscaled$climPC2),
                      habit=unique(sppcover.unscaled$habit),
                      perenneating = unique(sppcover.unscaled$perenneating)) %>% 
  mutate(pred.endcover=predict(object = climPC.mod.us,newdata=.,re.form=NA),
         pred.changecover = pred.endcover - startcover,prop.changecover = pred.changecover/(startcover+0.00001)) %>% 
  filter(perenneating == "below"&habit!="tree")

var_pred_df = expand.grid(startcover = startcover.range,
                      latmean1090 = median(sppcover.unscaled$latmean1090),
                      sitelat = median(sppcover.unscaled$sitelat),
                      min.gdd = median(sppcover.unscaled$min.gdd),
                      min.gs.ppt = median(sppcover.unscaled$min.gs.ppt),
                      min.wy.ppt = median(sppcover.unscaled$min.wy.ppt), 
                      max.tmean = median(sppcover.unscaled$max.tmean), 
                      habit=unique(sppcover.unscaled$habit),
                      perenneating = unique(sppcover.unscaled$perenneating)) %>% 
  mutate(pred.endcover=predict(object = climVar.mod.us,newdata=.,re.form=NA),
         pred.changecover = pred.endcover - startcover,
         prop.changecover = pred.changecover/(startcover+0.00001)) %>% 
  filter(perenneating == "below"&habit!="tree")

rects = data.frame(xmin=0,
                   xmax=max(startcover.range),
                   ymin=c(0.001,-1),
                   ymax=c(1.5,-0.001),
                   col=c("Increasing","Decreasing")) %>% 
  mutate(col = factor(col,levels=c("Increasing","Decreasing")))

ggplot()+
  geom_rect(data = rects,aes(xmin=xmin,xmax=xmax,ymin=ymin,ymax=ymax,fill=col),alpha=0.2)+
  geom_hline(yintercept = 0)+
  geom_line(data=plot_df,aes(x=startcover,y=pred.changecover,linetype=mod),linewidth=1.25)+
  theme_bw(base_size = 16) +
  facet_wrap(~habit,labeller=labeller(habit=c("forb"="Forbs","gram"="Graminoids","shrub"="Shrubs")))+
  #scale_color_manual(values=c("goldenrod","dodgerblue3"),labels=c("ClimPC model","ClimVar model"))+
  theme(legend.title = element_blank(),
        legend.key.width = unit(2,"cm"),
        panel.grid.minor = element_blank())+
  scale_linetype_manual(values=c(1,3))+
  scale_fill_manual(values=c("dodgerblue4","darkred"))+
  labs(x="Start cover",y="Change in cover")

# ggplot()+
#   geom_hline(yintercept = 0)+
#   geom_line(data=pc_pred_df,aes(x=startcover,y=pred.changecover,color="PC mod"),linewidth=1.5)+
#   geom_line(data=var_pred_df,aes(x=startcover,y=pred.changecover,color="var mod"),linewidth=1.5)+
#   theme_bw(base_size = 16) + 
#   facet_wrap(~habit,labeller=labeller(habit=c("forb"="Forbs","gram"="Graminoids","shrub"="Shrubs")))+
#   scale_color_manual(values=c("goldenrod","dodgerblue3"),labels=c("ClimPC model","ClimVar model"))+
#   theme(legend.title = element_blank(),
#         legend.direction = "horizontal",
#         legend.position = "top")+
#   labs(x="Start cover",y="Change in cover")
# 
# ggplot()+
#   geom_hline(yintercept = 0)+
#   geom_line(data=pc_pred_df,aes(x=startcover,y=(pred.changecover+0)/(startcover+0),color="PC mod"),linewidth=1.5)+
#   geom_line(data=var_pred_df,aes(x=startcover,y=(pred.changecover+0)/(startcover+0),color="var mod"),linewidth=1.5)+
#   theme_bw(base_size = 16) + 
#   facet_wrap(~habit,labeller=labeller(habit=c("forb"="Forbs","gram"="Graminoids","shrub"="Shrubs")))+
#   scale_color_manual(values=c("goldenrod","dodgerblue3"),labels=c("ClimPC model","ClimVar model"))+
#   theme(legend.title = element_blank(),
#         legend.direction = "horizontal",
#         legend.position = "top")+
#   labs(x="Start cover",y="Change in cover")

ggsave("Results/FinalFigures/figure9_avgmodresponses.png",dpi=500,h=7,w=10)

```

## Figures 10-12: forbs by clim PC drivers
### pred. change cover by site latitude, latmean1090, climPC1
```{r fig10_11_12_forbschangecover_by_climPCdrivers}
##### Create a dataframe with predicted end cover values from actual data points #####
forb.predicts = sppcover.unscaled %>% 
  filter(habit=="forb"&perenneating!="annual") %>% 
  mutate(pred.endcover = predict(climPC.mod.us,newdata=.,re.form=NA),
         pred.change = pred.endcover-startcover,
         obs.change = endcover - startcover) %>% filter(startcover>0)

## Get graminoid specific start cover quantiles at the 
forb.predicts$startnames = NA

# Quantile values 
forbQs = c(quantile(forb.predicts$startcover,probs=c(0.25)),quantile(forb.predicts$startcover,probs=c(0.5)),quantile(forb.predicts$startcover,probs=c(0.8)) ) 
forbQs
## now assign factor var based on ranges around these quantiles. 
forb.predicts$startnames[which(abs(forb.predicts$startcover - forbQs[1])<=0.2)]='Low'
forb.predicts$startnames[which(abs(forb.predicts$startcover - forbQs[2])<=0.2)]='Med'
forb.predicts$startnames[which(abs(forb.predicts$startcover - forbQs[3])<=0.5)]='High'

table(forb.predicts$startnames)

# Set factor level order for plots
forb.predicts$startnames = factor(forb.predicts$startnames,levels=c("Low","Med","High"))

## Create a new data.frame that gets rid of data points that don't have a H, M, or L value
forb.plots = forb.predicts  %>% 
  filter(!is.na(startnames))
table(forb.plots$startnames)
#####

## Now create a more generic dataframe that has mean values for predictor variables. This will be use to add lines to plots with actual data
##### site lat driver ####
forb.sitelat.lines = expand.grid(startcover = forbQs,
                         sitelat = unique(forb.predicts$sitelat),
                         climPC1 = median(forb.predicts$climPC1),
                         climPC2 = median(forb.predicts$climPC2),
                         habit="forb",
                         perenneating = unique(forb.predicts$perenneating),
                         latmean1090 = median(forb.predicts$latmean1090)
                         ) %>% 
  mutate(pred.endcover = predict(climPC.mod.us,newdata=.,re.form=NA),
         pred.change = pred.endcover - startcover,
         startnames=ifelse(startcover==forbQs[1],"Low",
                           ifelse(startcover==forbQs[2],"Med","High")))
forb.sitelat.lines$startnames = factor(forb.sitelat.lines$startnames,levels=c("High","Med","Low"))

ggplot() + 
  geom_hline(yintercept = 0)+
  geom_jitter(data=filter(forb.plots,perenneating=="below"), aes(x=sitelat,y=pred.change,group=startnames,color=startnames),
              width = 0.2, height = 0.2,alpha=0.7,stroke=NA,size=2) +
  geom_line(data=filter(forb.sitelat.lines,perenneating=="below"), aes(x=sitelat,y=pred.change, group=startnames, color=startnames),
            linewidth=1.5) +
  scale_color_manual(values=cover.pal3) +
  theme_bw(base_size = 14)+
  labs(x="Site latitude",y="Change in cover",
       # title ='Forbs: change cover by site latitude',
       color="Start cover\ncategory") +
  facet_grid2(perenneating~startnames,scales="free_y",independent = "y",labeller = labeller(perenneating=c("above"="Above-ground","below"="Below-ground")))+
  theme(strip.text = element_blank())+
  guides(colour = guide_legend(title.position = "top",title.hjust = 0.5))
ggsave("Results/FinalFigures/figure10_forbs_by_sitelat.png",dpi=400,h=4,w=10)
###

##### latmean1090 driver ###
forb.latmean.lines = expand.grid(startcover = forbQs,
                         sitelat = median(forb.predicts$sitelat),
                         climPC1 = median(forb.predicts$climPC1),
                         climPC2 = median(forb.predicts$climPC2),
                         habit="forb",
                         perenneating = unique(forb.predicts$perenneating),
                         latmean1090 = seq(quantile(forb.predicts$latmean1090,0),quantile(forb.predicts$latmean1090,1),length.out=20)
                         ) %>% 
  mutate(pred.endcover = predict(climPC.mod.us,newdata=.,re.form=NA),
         pred.change = pred.endcover - startcover,
         startnames=ifelse(startcover==forbQs[1],"Low",
                           ifelse(startcover==forbQs[2],"Med","High")))
forb.latmean.lines$startnames = factor(forb.latmean.lines$startnames,levels=c("High","Med","Low"))

ggplot() + 
  geom_hline(yintercept = 0)+
  geom_jitter(data=filter(forb.plots,perenneating=="below"), aes(x=latmean1090,y=pred.change,group=startnames,color=startnames),
              width = 0.2, height = 0.2,alpha=0.7,stroke=NA,size=2) +
  geom_line(data=filter(forb.latmean.lines,perenneating=="below"), aes(x=latmean1090,y=pred.change, group=startnames, color=startnames),
            linewidth=1.5) +
  scale_color_manual(values=cover.pal3) +
  theme_bw(base_size = 14)+
  labs(x="Mean spp. latitude",y="Change in cover",
       # title ='Forbs: change cover by mean species latitude', 
       color="Start cover\ncategory") +
  facet_grid2(perenneating~startnames,scales="free_y",independent = "y",labeller = labeller(perenneating=c("above"="Above-ground","below"="Below-ground")))+
  theme(strip.text = element_blank())+
  guides(colour = guide_legend(title.position = "top",title.hjust = 0.5))
ggsave("Results/FinalFigures/figure11_forbs_by_latmean1090.png",dpi=400,h=4,w=10)

##### climPC1 driver ###
forb.climPC1.lines = expand.grid(startcover = forbQs,
                         sitelat = median(forb.predicts$sitelat),
                         climPC1 = seq(min(forb.predicts$climPC1),max(forb.predicts$climPC1),length.out=10),
                         climPC2 = median(forb.predicts$climPC2),
                         habit="forb",
                         perenneating = unique(forb.predicts$perenneating),
                         latmean1090 = median(forb.predicts$latmean1090)
                         ) %>% 
  mutate(pred.endcover = predict(climPC.mod.us,newdata=.,re.form=NA),
         pred.change = pred.endcover - startcover,
         startnames=ifelse(startcover==forbQs[1],"Low",
                           ifelse(startcover==forbQs[2],"Med","High")))
forb.climPC1.lines$startnames = factor(forb.climPC1.lines$startnames,levels=c("High","Med","Low"))

ggplot() + 
  geom_hline(yintercept = 0)+
  geom_jitter(data=filter(forb.plots,perenneating=="below"), aes(x=climPC1,y=pred.change,group=startnames,color=startnames),
              width = 0.2, height = 0.2,alpha=0.7,stroke=NA,size=2) +
  geom_line(data=filter(forb.climPC1.lines,perenneating=="below"), aes(x=climPC1,y=pred.change, group=startnames, color=startnames),
            linewidth=1.5) +
  scale_color_manual(values=cover.pal3) +
  theme_bw(base_size = 14)+
  labs(x="climPC1",y="Change in cover",
       # title ='Forbs: change cover by clim PC1',
       color="Start cover\ncategory") +
  facet_grid2(perenneating~startnames,scales="free_y",independent = "y",labeller = labeller(perenneating=c("above"="Above-ground","below"="Below-ground")))+
  theme(strip.text = element_blank())+
  guides(colour = guide_legend(title.position = "top",title.hjust = 0.5))
ggsave("Results/FinalFigures/figure12_forbs_by_climPC1.png",dpi=400,h=4,w=10)

```

## Figure 13: Forbs by clim var drivers
```{r fig18_forbschangecover_by_climVARdrivers}
##### Create a dataframe with predicted end cover values from actual data points #####
forb.predicts = sppcover.unscaled %>% 
  filter(habit=="forb"&perenneating!="annual") %>% 
  mutate(pred.endcover = predict(climVar.mod.us,newdata=.,re.form=NA),
         pred.change = pred.endcover-startcover,
         obs.change = endcover - startcover) %>% filter(startcover>0)

## Get graminoid specific start cover quantiles at the 
forb.predicts$startnames = NA

# Quantile values 
forbQs = c(quantile(forb.predicts$startcover,probs=c(0.25)),
           quantile(forb.predicts$startcover,probs=c(0.5)),
           quantile(forb.predicts$startcover,probs=c(0.8)) ) 

## now assign factor var based on ranges around these quantiles. 
forb.predicts$startnames[which(abs(forb.predicts$startcover - forbQs[1])<=0.1)]='Low'
forb.predicts$startnames[which(abs(forb.predicts$startcover - forbQs[2])<=0.2)]='Med'
forb.predicts$startnames[which(abs(forb.predicts$startcover - forbQs[3])<=0.5)]='High'

# Set factor level order for plots
forb.predicts$startnames = factor(forb.predicts$startnames,levels=c("Low","Med","High"))

## Create a new data.frame that gets rid of data points that don't have a H, M, or L value
forb.plots = forb.predicts  %>% 
  filter(!is.na(startnames))
#####

## Now create a more generic dataframes that has mean values for predictor variables. This will be use to add lines to plots with actual data
#### min.wy.ppt ####
forb.wyppt.lines = expand.grid(sitelat = median(forb.predicts$sitelat),
                             startcover = forbQs,
                             min.wy.ppt = seq(min(forb.predicts$min.wy.ppt),max(forb.predicts$min.wy.ppt),length.out=10),
                             min.gs.ppt = median(forb.predicts$min.gs.ppt),
                             min.gdd = median(forb.predicts$min.gdd),
                             max.tmean = median(forb.predicts$max.tmean),
                             habit="forb",
                             perenneating = unique(forb.predicts$perenneating),
                             latmean1090 = median(forb.predicts$latmean1090)) %>% 
  mutate(pred.endcover = predict(climVar.mod.us,newdata=.,re.form=NA),
         pred.change = pred.endcover - startcover,
         startnames=ifelse(startcover==forbQs[1],"Low",
                           ifelse(startcover==forbQs[2],"Med","High")))
forb.wyppt.lines$startnames = factor(forb.wyppt.lines$startnames,levels=c("High","Med","Low"))

wy.forbs = ggplot() + 
  geom_hline(yintercept = 0)+
  geom_jitter(data=filter(forb.plots,perenneating=="below"), aes(x=min.wy.ppt,y=pred.change,group=startnames,color=startnames),
              width = 0.2, height = 0.2,alpha=0.70,stroke=NA,size=2) +
  geom_line(data=filter(forb.wyppt.lines,perenneating=="below"), aes(x=min.wy.ppt,y=pred.change, group=startnames, color=startnames),
            linewidth=1.5) +
  scale_color_manual(values=cover.pal3) +
  theme_bw(base_size = 14)+
  labs(x="Water year ppt",y="Change in cover",
       # title ='Forbs: change cover by water year ppt', 
       color="Start cover\ncategory") +
  #facet_wrap(~startnames,scales="free_y")+
  facet_grid2(perenneating~startnames,scales="free_y",independent = "y",labeller = labeller(perenneating=c("above"="Above-ground","below"="Below-ground")))+
  theme(strip.text = element_blank())+
  guides(colour = guide_legend(title.position = "top",title.hjust = 0.5));wy.forbs
# ggsave("Results/FinalFigures/figure18a_forbs_by_wyppt.png",dpi=300,h=6,w=10)
######

#### min.gs.ppt ####
forb.gsppt.lines = expand.grid(sitelat = median(forb.predicts$sitelat),
                             startcover = forbQs,
                             min.gs.ppt = seq(min(forb.predicts$min.gs.ppt),max(forb.predicts$min.gs.ppt),length.out=10),
                             min.wy.ppt = median(forb.predicts$min.wy.ppt),
                             min.gdd = median(forb.predicts$min.gdd),
                             max.tmean = median(forb.predicts$max.tmean),
                             habit="forb",
                             perenneating = unique(forb.predicts$perenneating),
                             latmean1090 = median(forb.predicts$latmean1090)) %>% 
  mutate(pred.endcover = predict(climVar.mod.us,newdata=.,re.form=NA),
         pred.change = pred.endcover - startcover,
         startnames=ifelse(startcover==forbQs[1],"Low",
                           ifelse(startcover==forbQs[2],"Med","High")))
forb.gsppt.lines$startnames = factor(forb.gsppt.lines$startnames,levels=c("High","Med","Low"))

gs.forbs = ggplot() + 
  geom_hline(yintercept = 0)+
  geom_jitter(data=filter(forb.plots,perenneating=="below"), aes(x=min.gs.ppt,y=pred.change,group=startnames,color=startnames),
              width = 0.2, height = 0.2,alpha=0.70,stroke=NA,size=2) +
  geom_line(data=filter(forb.gsppt.lines, perenneating=="below"), aes(x=min.gs.ppt,y=pred.change, group=startnames, color=startnames),
            linewidth=1.5) +
  scale_color_manual(values=cover.pal3) +
  theme_bw(base_size = 14)+
  labs(x="Growing season ppt",y="Change in cover",
       # title ='Forbs: change cover by growing season ppt', 
       color="Start cover\ncategory") +
  # facet_wrap(~startnames,scales="free_y")+
  facet_grid2(perenneating~startnames,scales="free_y",independent = "y",labeller = labeller(perenneating=c("above"="Above-ground","below"="Below-ground")))+
  theme(strip.text = element_blank())+
  guides(colour = guide_legend(title.position = "top",title.hjust = 0.5));gs.forbs
# ggsave("Results/FinalFigures/figure18b_forbs_by_gsppt.png",dpi=300,h=6,w=10)
######
#### GDD ####
forb.gdd.lines = expand.grid(sitelat = median(forb.predicts$sitelat),
                             startcover = forbQs,
                             min.gdd = seq(min(forb.predicts$min.gdd),max(forb.predicts$min.gdd),length.out=10),
                             min.gs.ppt = median(forb.predicts$min.gs.ppt),
                             min.wy.ppt = median(forb.predicts$min.wy.ppt),
                             max.tmean = median(forb.predicts$max.tmean),
                             habit="forb",
                             perenneating = unique(forb.predicts$perenneating),
                             latmean1090 = median(forb.predicts$latmean1090)) %>%
  mutate(pred.endcover = predict(climVar.mod.us,newdata=.,re.form=NA),
         pred.change = pred.endcover - startcover,
         startnames=ifelse(startcover==forbQs[1],"Low",
                           ifelse(startcover==forbQs[2],"Med","High")))
forb.gdd.lines$startnames = factor(forb.gdd.lines$startnames,levels=c("High","Med","Low"))

gdd.forbs = ggplot() +
  geom_hline(yintercept = 0)+
  geom_jitter(data=filter(forb.plots, perenneating=="below"), aes(x=min.gdd,y=pred.change,group=startnames,color=startnames),
              width = 0.2, height = 0.2,alpha=0.70,stroke=NA,size=2) +
  geom_line(data=filter(forb.gdd.lines,perenneating=="below"), aes(x=min.gdd,y=pred.change, group=startnames, color=startnames),
            linewidth=1.5) +
  scale_color_manual(values=cover.pal3) +
  theme_bw(base_size = 14)+
  labs(x="Growing degree days",y="Change in cover",
       # title ='Forbs: change cover by growing degree days', 
       color="Start cover\ncategory") +
  facet_grid2(perenneating~startnames,scales="free_y",independent = "y",labeller = labeller(perenneating=c("above"="Above-ground","below"="Below-ground")))+
  theme(strip.text = element_blank())+
  guides(colour = guide_legend(title.position = "top",title.hjust = 0.5));gdd.forbs
legend = get_legend(gdd.forbs)

# ggsave("Results/FinalFigures/figure18c_forbs_by_gdd.png",dpi=300,h=6,w=10)
######

cowplot::plot_grid(wy.forbs+theme(legend.position = "none"),NULL,
                   gs.forbs+theme(legend.position = "none"),legend,
                   gdd.forbs+theme(legend.position = "none"),NULL,
                   ncol=2,rel_widths = c(0.8,0.1))
ggsave("Results/FinalFigures/figure13_forbs_by_climVars.png",dpi=400,h=11,w=10)
```

## Figure 14: Grams and shrubs by sitelat
```{r fig19_grams_shrubs_sitelat}
##### Grams by sitelat (climPC mod) #####
## Create a dataframe with predicted end cover values from actual data points ##
gram.predicts = sppcover.unscaled %>% 
  filter(habit=="gram") %>% 
  mutate(pred.endcover = predict(climPC.mod.us,newdata=.,re.form=NA),
         pred.change = pred.endcover-startcover,
         obs.change = endcover - startcover) %>% filter(startcover>0)

## Get graminoid specific start cover quantiles at the 
gram.predicts$startnames = NA

# Quantile values for method 1
gramQs = c(quantile(gram.predicts$startcover,probs=c(0.2)),quantile(gram.predicts$startcover,probs=c(0.5)),quantile(gram.predicts$startcover,probs=c(0.8))) 

## now assign factor var based on ranges around these quantiles. 
gram.predicts$startnames[which(abs(gram.predicts$startcover - gramQs[1])<=0.5)]='Low'
gram.predicts$startnames[which(abs(gram.predicts$startcover - gramQs[2])<=0.25)]='Med'
gram.predicts$startnames[which(abs(gram.predicts$startcover - gramQs[3])<=0.5)]='High'

# Set factor level order for plots
gram.predicts$startnames = factor(gram.predicts$startnames,levels=c("Low","Med","High"))

## Create a new data.frame that gets rid of data points that don't have a H, M, or L value
gram.plots = gram.predicts  %>% 
  filter(!is.na(startnames))

## Now create a more generic dataframes that has mean values for predictor variables. This will be use to add lines to plots with actual data
### Site latitude driver ##
gram.sitelat.lines = expand.grid(sitelat = unique(gram.predicts$sitelat),
                                 startcover = gramQs,
                                 climPC1 = median(gram.predicts$climPC1),
                                 climPC2 = median(gram.predicts$climPC2),
                                 habit="gram",
                                 perenneating = unique(gram.predicts$perenneating),
                                 latmean1090 = median(gram.predicts$latmean1090)) %>% 
  mutate(pred.endcover = predict(climPC.mod.us,newdata=.,re.form=NA),
         pred.change = pred.endcover - startcover,
         startnames=ifelse(startcover==gramQs[1],"Low",
                           ifelse(startcover==gramQs[2],"Med","High")))
gram.sitelat.lines$startnames = factor(gram.sitelat.lines$startnames,levels=c("High","Med","Low"))

grams = ggplot() + 
  geom_hline(yintercept = 0)+
  geom_jitter(data=gram.plots, aes(x=sitelat,y=pred.change,group=startnames,color=startnames),
              width = 0.2, height = 0.2,alpha=0.5,stroke=NA) +
  geom_line(data=gram.sitelat.lines, aes(x=sitelat,y=pred.change, group=startnames, color=startnames),
            linewidth=1.5) +
  scale_color_manual(values=cover.pal3) +
  theme_bw(base_size = 14)+
  labs(x="Site latitude",y="Change in cover",
       title = "A. Graminoids",
       # title ='Graminoids: change cover by site latitude',
       color="Start cover\ncategory") +
  facet_wrap(~startnames)+ 
  theme(strip.text.x = element_blank(),
        plot.title = element_text(face="bold"))+
  guides(colour = guide_legend(title.position = "top",title.hjust = 0.5))
ggsave("Results/FinalFigures/figure19a_grams_sitelat.png",dpi=300,h=5,w=10)
##### End grams by site lat #####

##### Shrubs by sitelat (climPC mod) #####
#### Create a dataframe with predicted end cover values from actual data points ###
shrub.predicts = sppcover.unscaled %>% 
  filter(habit=="shrub") %>% 
  mutate(pred.endcover = predict(climPC.mod.us,newdata=.,re.form=NA),
         pred.change = pred.endcover-startcover,
         obs.change = endcover - startcover) %>% filter(startcover>0)

## Get shrub specific start cover quantiles at the 
shrub.predicts$startnames = NA

# Quantile values for method 1
shrubQs = c(quantile(shrub.predicts$startcover,probs=c(0.5))) 
shrubQs
## now assign factor var based on ranges around these quantiles. 
shrub.predicts$startnames = ifelse(shrub.predicts$startcover<=shrubQs[1],"Low","High")

table(shrub.predicts$startnames)

# Set factor level order for plots
shrub.predicts$startnames = factor(shrub.predicts$startnames,levels=c("Low","High"))

## Now create a more generic dataframe that has mean values for predictor variables. This will be use to add lines to plots with actual data
startcover.vals = c(mean(shrub.predicts$startcover[shrub.predicts$startnames=="Low"]),mean(shrub.predicts$startcover[shrub.predicts$startnames=="High"]))
###

## Site latitude driver ###
shrub.sitelat.lines = expand.grid(startcover = startcover.vals,
                          sitelat = unique(shrub.predicts$sitelat),
                         climPC1 = median(sppcover.unscaled$climPC1),
                         climPC2 = median(sppcover.unscaled$climPC2),
                         habit="shrub",
                         perenneating = unique(shrub.predicts$perenneating),
                         latmean1090 = median(shrub.predicts$latmean1090)) %>% 
  mutate(pred.endcover = predict(climPC.mod.us,newdata=.,re.form=NA),
         pred.change = pred.endcover - startcover,
         startnames = ifelse(startcover==startcover.vals[1],"Low","High"))
shrub.sitelat.lines$startnames = factor(shrub.sitelat.lines$startnames,levels=c("High","Low"))
shrubs = ggplot() + 
  geom_hline(yintercept = 0)+
  geom_jitter(data=shrub.predicts, aes(x=sitelat,y=pred.change,group=startnames,color=startnames),
              width = 0.2, height = 0.2,alpha=0.75,stroke=NA) +
  geom_line(data=shrub.sitelat.lines, aes(x=sitelat,y=pred.change, group=startnames, color=startnames),
            linewidth=1.5) +
  scale_color_manual(values=cover.pal3) +
  theme_bw(base_size = 14)+
  labs(x="Site latitude",y="Change in cover",
       # title ='Shrubs: change cover by site latitude', 
       title="B. Shrubs",
       color="Start cover\ncategory") +
  facet_wrap(~startnames)+ 
  theme(strip.text.x = element_blank(),
        plot.title=element_text(face="bold"))+
  guides(colour = guide_legend(title.position = "top",title.hjust = 0.5))
# ggsave("Results/FinalFigures/figure19b_shrubs_sitelat.png",dpi=400,h=5,w=7)
shrubs2 = cowplot::plot_grid(NULL,shrubs,NULL,rel_widths = c(0.1,1,0.1),ncol=3)
cowplot::plot_grid(grams,shrubs2,ncol=1,align = "v",axis = "lb")
ggsave("Results/FinalFigures/figure19_grams_shrubs_sitelat.png",dpi=300,h=10,w=10)
### end sitelat driver ###
##### End shrubs #####



```

## Random effects figures set-up
```{r getREestimtes}
climPC.REs = ranef(climPC.mod.us,condVar=T) %>% 
  as.data.frame() %>% 
    mutate(lower.95ci = condval-condsd*1.96,
           upper.95ci = condval+condsd*1.96,
           nonzero.95ci = ifelse(lower.95ci<0&upper.95ci>0,0,1))

climPC.REs.wide = pivot_wider(climPC.REs, id_cols = c(grpvar,grp),names_from = term,values_from = condval) %>% 
  rename("intercept"="(Intercept)")

sig.climPC.REs = climPC.REs %>% 
  filter(grpvar!="transition") %>% 
  filter(term!="(Intercept)") %>% 
  filter(nonzero.95ci==1) %>% 
  select(-grpvar) %>% 
  rename("species"=grp) %>% 
  mutate(species=as.character(species))

climVar.REs = ranef(climVar.mod.us,condVar=T) %>% 
  as.data.frame() %>% 
  mutate(lower.95ci = condval-condsd*1.96,
         upper.95ci = condval+condsd*1.96,
         nonzero.95ci = ifelse(lower.95ci<0&upper.95ci>0,0,1))
climVar.REs.wide = pivot_wider(climVar.REs, id_cols = c(grpvar,grp),names_from = term,values_from = condval) %>% 
  rename("intercept"="(Intercept)")

sig.climVar.REs = climVar.REs %>% 
  filter(grpvar!="transition") %>% 
  filter(term!="(Intercept)") %>% 
  mutate(lower.95ci = condval-condsd*1.96,
         upper.95ci = condval+condsd*1.96,
         nonzero.95ci = ifelse(lower.95ci<0&upper.95ci>0,0,1)) %>% 
  filter(nonzero.95ci==1) %>% 
  select(-grpvar) %>% 
  rename("species"=grp) %>% 
  mutate(species=as.character(species)) 

REsigSpp = c(as.character(sig.climPC.REs$species),
                  as.character(sig.climVar.REs$species)) %>% unique() %>% sort()

```

## Figures 15-17
### aesthetics setup
```{r fig15_16_17setup}

sigREcolpal = c("All above-ground forbs"="grey20",
                "All below-ground forbs"="grey20",
                "All graminoids"="grey20",

                ## Grams
                "Carex elynoides"="firebrick4",
                "Carex obtusata"="darkorange2",
                "Carex rupestris"="slateblue1",
                "Carex paysonis"="goldenrod3",
                "Carex rossii"="yellow3",
                "Danthonia intermedia"="forestgreen",
                "Festuca brachyphylla"="turquoise2",
                "Kobresia myosuroides"="purple",
                "Poa glauca"="darkblue",
                "Juncus drummondii"="dodgerblue",

                ## Above ground forbs
                "Paronychia pulvinata"="forestgreen",
                "Minuartia obtusiloba"="springgreen3",

                #below-ground forbs
                "Agoseris glauca"="blue",
                "Arenaria congesta"="aquamarine3",
                "Arenaria fendleri"="deeppink2",
                "Astragalus bourgovii"="darkturquoise",
                "Erigeron melanocephalus"="palegreen3",
                "Erigeron ochroleucus"="purple4",
                "Erigeron rydbergii"="darkorange3",
                "Erigeron simplex"="steelblue4" ,
                "Erigeron ursinus" ="lightblue2",
                "Geum rossii"="chartreuse4",
                "Oreoxis alpina"="steelblue3",
                "Oreostemma alpigenum"="blue3",
                "Phlox multiflora"="limegreen",
                "Phlox pulvinata"="darkgreen",
                "Potentilla pulcherrima"="slateblue3",
                "Potentilla subjuga" = "rosybrown3",
                "Symphyotrichum foliaceum"="violetred1",
                "Trifolium dasyphyllum"="magenta3",
                "Trifolium nanum"="coral2",
                "Vaccinium scoparium"="darkred")

spp.lw = 0.75
all.lw = 2
base_size = 14
legend_textsize = 13
```

### Figure 15-17 data prep
```{r fig15_16_17_data}
# sig.REs = rbind(sig.climPC.REs,sig.climVar.REs)
startcover.val = quantile(sppcover.unscaled$startcover[sppcover.unscaled$startcover>0],0.25)

##### Clim PC1 #####
climPC1spp = sig.climPC.REs$species[sig.climPC.REs$term=="climPC1"]
pred.df.climPC1 = expand.grid(startcover = startcover.val,
                              climPC1 = seq(min(sppcover.unscaled$climPC1),max(sppcover.unscaled$climPC1),length.out=10),
                              climPC2 = median(sppcover.unscaled$climPC2),
                              habit=c("gram","forb"),
                              sciname="main",
                              perenneating=c("below","above"),
                              latmean1090=median(sppcover.unscaled$latmean1090),
                              sitelat = median(sppcover.unscaled$sitelat)) %>% 
  filter(!(habit=="gram"&perenneating=="above")) %>% 
  mutate(pred.endcover = predict(climPC.mod.us,newdata=.,re.form=NA),
         pred.changecover = pred.endcover-startcover) %>% 
  mutate(label = case_when(habit=="gram"~"All graminoids",
                           habit=="forb"&perenneating=="above"~"All above-ground forbs",
                           habit=="forb"&perenneating=="below"~"All below-ground forbs"),
         label=label,habit.group = label)

for(i in 1:length(climPC1spp)){
  
  spp = climPC1spp[i]
  pred.df.spp = expand.grid(startcover = startcover.val,
                            climPC1 = seq(min(sppcover.unscaled$climPC1),max(sppcover.unscaled$climPC1),length.out=10),
                            climPC2 = median(sppcover.unscaled$climPC2),
                            sciname=spp,
                            habit=unique(sppcover.unscaled$habit[sppcover.unscaled$sciname==spp]),
                            perenneating=unique(sppcover.unscaled$perenneating[sppcover.unscaled$sciname==spp]),
                            latmean1090=median(sppcover.unscaled$latmean1090),
                            sitelat = median(sppcover.unscaled$sitelat)) %>% 
    mutate(pred.endcover = predict(climPC.mod.us,newdata=.,re.form=~(climPC1|sciname)),
           pred.changecover = pred.endcover-startcover) %>% 
    mutate(label=spp) %>% 
    mutate(habit.group = case_when(habit=="gram"~"All graminoids",
                                   habit=="forb"&perenneating=="above"~"All above-ground forbs",
                                   habit=="forb"&perenneating=="below"~"All below-ground forbs"))
  pred.df.climPC1 = rbind(pred.df.climPC1,pred.df.spp)
  
}
##### end climPC1 #####

###### climPC2 #####
climPC2spp = sig.climPC.REs$species[sig.climPC.REs$term=="climPC2"]
pred.df.climPC2 = expand.grid(startcover = startcover.val,
                              climPC2 = seq(min(sppcover.unscaled$climPC2),max(sppcover.unscaled$climPC2),length.out=10),
                              climPC1 = median(sppcover.unscaled$climPC1),
                              habit=c("gram","forb"),
                              sciname="main",
                              perenneating=c("below","above"),
                              latmean1090=median(sppcover.unscaled$latmean1090),
                              sitelat = median(sppcover.unscaled$sitelat)) %>% 
  filter(!(habit=="gram"&perenneating=="above")) %>% 
  mutate(pred.endcover = predict(climPC.mod.us,newdata=.,re.form=NA),
         pred.changecover = pred.endcover-startcover) %>% 
  mutate(label = case_when(habit=="gram"~"All graminoids",
                           habit=="forb"&perenneating=="above"~"All above-ground forbs",
                           habit=="forb"&perenneating=="below"~"All below-ground forbs"),
         habit.group = label)

for(i in 1:length(climPC2spp)){
  
  spp = climPC2spp[i]
  pred.df.spp = expand.grid(startcover = startcover.val,
                            climPC2 = seq(min(sppcover.unscaled$climPC2),max(sppcover.unscaled$climPC2),length.out=10),
                            climPC1 = median(sppcover.unscaled$climPC1),
                            sciname=spp,
                            habit=unique(sppcover.unscaled$habit[sppcover.unscaled$sciname==spp]),
                            perenneating=unique(sppcover.unscaled$perenneating[sppcover.unscaled$sciname==spp]),
                            latmean1090=median(sppcover.unscaled$latmean1090),
                            sitelat = median(sppcover.unscaled$sitelat)) %>% 
    mutate(pred.endcover = predict(climPC.mod.us,newdata=.,re.form=~(climPC2|sciname)),
           pred.changecover = pred.endcover-startcover) %>% 
    mutate(label=spp) %>% 
    mutate(habit.group = case_when(habit=="gram"~"All graminoids",
                                   habit=="forb"&perenneating=="above"~"All above-ground forbs",
                                   habit=="forb"&perenneating=="below"~"All below-ground forbs"))
  pred.df.climPC2 = rbind(pred.df.climPC2,pred.df.spp)
  
}
##### End climPC2 #####

##### wy.ppt #####
WYpptspp = sig.climVar.REs$species[sig.climVar.REs$term=="min.wy.ppt"]
pred.df.WYppt = expand.grid(startcover = startcover.val,
                            min.gdd = median(sppcover.unscaled$min.gdd),
                            min.gs.ppt = median(sppcover.unscaled$min.gs.ppt),
                            max.tmean = median(sppcover.unscaled$max.tmean),
                            min.wy.ppt = seq(min(sppcover.unscaled$min.wy.ppt),max(sppcover.unscaled$min.wy.ppt),length.out=10),
                            habit=c("gram","forb"),
                            sciname="main",
                            perenneating=c("below","above"),
                            latmean1090=median(sppcover.unscaled$latmean1090),
                            sitelat = median(sppcover.unscaled$sitelat)) %>% 
  filter(!(habit=="gram"&perenneating=="above")) %>% 
  mutate(pred.endcover = predict(climVar.mod.us,newdata=.,re.form=NA),
         pred.changecover = pred.endcover-startcover) %>% 
  mutate(label = case_when(habit=="gram"~"All graminoids",
                           habit=="forb"&perenneating=="above"~"All above-ground forbs",
                           habit=="forb"&perenneating=="below"~"All below-ground forbs"),
         habit.group = label)

for(i in 1:length(WYpptspp)){
  
  spp = WYpptspp[i]
  pred.df.spp = expand.grid(startcover = startcover.val,
                            min.gdd = median(sppcover.unscaled$min.gdd),
                            min.gs.ppt = median(sppcover.unscaled$min.gs.ppt),
                            max.tmean = median(sppcover.unscaled$max.tmean),
                            min.wy.ppt = seq(min(sppcover.unscaled$min.wy.ppt),max(sppcover.unscaled$min.wy.ppt),length.out=10),
                            sciname=spp,
                            habit=unique(sppcover.unscaled$habit[sppcover.unscaled$sciname==spp]),
                            perenneating=unique(sppcover.unscaled$perenneating[sppcover.unscaled$sciname==spp]),
                            latmean1090=median(sppcover.unscaled$latmean1090),
                            sitelat = median(sppcover.unscaled$sitelat)) %>% 
    mutate(pred.endcover = predict(climVar.mod.us,newdata=.,re.form=~(min.wy.ppt|sciname)),
           pred.changecover = pred.endcover-startcover) %>% 
    mutate(label=spp) %>% 
    mutate(habit.group = case_when(habit=="gram"~"All graminoids",
                                   habit=="forb"&perenneating=="above"~"All above-ground forbs",
                                   habit=="forb"&perenneating=="below"~"All below-ground forbs"))
  pred.df.WYppt = rbind(pred.df.WYppt,pred.df.spp)
  
}
##### end wy.ppt #####

##### gs.ppt #####
GSpptspp = sig.climVar.REs$species[sig.climVar.REs$term=="min.gs.ppt"]
pred.df.GSppt = expand.grid(startcover = startcover.val,
                            min.gdd = median(sppcover.unscaled$min.gdd),
                            min.wy.ppt = median(sppcover.unscaled$min.wy.ppt),
                            max.tmean = median(sppcover.unscaled$max.tmean),
                            min.gs.ppt = seq(min(sppcover.unscaled$min.gs.ppt),max(sppcover.unscaled$min.gs.ppt),length.out=10),
                            habit=c("gram","forb"),
                            sciname="main",
                            perenneating=c("below","above"),
                            latmean1090=median(sppcover.unscaled$latmean1090),
                            sitelat = median(sppcover.unscaled$sitelat)) %>% 
  filter(!(habit=="gram"&perenneating=="above")) %>% 
  mutate(pred.endcover = predict(climVar.mod.us,newdata=.,re.form=NA),
         pred.changecover = pred.endcover-startcover) %>% 
  mutate(label = case_when(habit=="gram"~"All graminoids",
                           habit=="forb"&perenneating=="above"~"All above-ground forbs",
                           habit=="forb"&perenneating=="below"~"All below-ground forbs"),
         habit.group = label)

for(i in 1:length(GSpptspp)){
  
  spp = GSpptspp[i]
  pred.df.spp = expand.grid(startcover = startcover.val,
                            min.gdd = median(sppcover.unscaled$min.gdd),
                            min.wy.ppt = median(sppcover.unscaled$min.wy.ppt),
                            max.tmean = median(sppcover.unscaled$max.tmean),
                            min.gs.ppt = seq(min(sppcover.unscaled$min.gs.ppt),max(sppcover.unscaled$min.gs.ppt),length.out=10),
                            sciname=spp,
                            habit=unique(sppcover.unscaled$habit[sppcover.unscaled$sciname==spp]),
                            perenneating=unique(sppcover.unscaled$perenneating[sppcover.unscaled$sciname==spp]),
                            latmean1090=median(sppcover.unscaled$latmean1090),
                            sitelat = median(sppcover.unscaled$sitelat)) %>% 
    mutate(pred.endcover = predict(climVar.mod.us,newdata=.,re.form=~(min.gs.ppt|sciname)),
           pred.changecover = pred.endcover-startcover) %>% 
    mutate(label=spp) %>% 
    mutate(habit.group = case_when(habit=="gram"~"All graminoids",
                                   habit=="forb"&perenneating=="above"~"All above-ground forbs",
                                   habit=="forb"&perenneating=="below"~"All below-ground forbs"))
  pred.df.GSppt = rbind(pred.df.GSppt,pred.df.spp)
  
}
##### end gs.ppt #####

##### gdd #####
GDDspp = sig.climVar.REs$species[sig.climVar.REs$term=="min.gdd"]
pred.df.GDD = expand.grid(startcover = startcover.val,
                            min.gdd = seq(min(sppcover.unscaled$min.gdd),max(sppcover.unscaled$min.gdd),length.out=10),
                            min.wy.ppt = median(sppcover.unscaled$min.wy.ppt),
                            max.tmean = median(sppcover.unscaled$max.tmean),
                            min.gs.ppt = median(sppcover.unscaled$min.gs.ppt),
                            habit=c("gram","forb"),
                            sciname="main",
                            perenneating=c("below","above"),
                            latmean1090=median(sppcover.unscaled$latmean1090),
                            sitelat = median(sppcover.unscaled$sitelat)) %>% 
  filter(!(habit=="gram"&perenneating=="above")) %>% 
  mutate(pred.endcover = predict(climVar.mod.us,newdata=.,re.form=NA),
         pred.changecover = pred.endcover-startcover) %>% 
  mutate(label = case_when(habit=="gram"~"All graminoids",
                           habit=="forb"&perenneating=="above"~"All above-ground forbs",
                           habit=="forb"&perenneating=="below"~"All below-ground forbs"),
         habit.group = label)

for(i in 1:length(GDDspp)){
  
  spp = GDDspp[i]
  pred.df.spp = expand.grid(startcover = startcover.val,
                            min.gdd = seq(min(sppcover.unscaled$min.gdd),max(sppcover.unscaled$min.gdd),length.out=10),
                            min.wy.ppt = median(sppcover.unscaled$min.wy.ppt),
                            max.tmean = median(sppcover.unscaled$max.tmean),
                            min.gs.ppt = median(sppcover.unscaled$min.gs.ppt),
                            sciname=spp,
                            habit=unique(sppcover.unscaled$habit[sppcover.unscaled$sciname==spp]),
                            perenneating=unique(sppcover.unscaled$perenneating[sppcover.unscaled$sciname==spp]),
                            latmean1090=median(sppcover.unscaled$latmean1090),
                            sitelat = median(sppcover.unscaled$sitelat)) %>% 
    mutate(pred.endcover = predict(climVar.mod.us,newdata=.,re.form=~(min.gdd|sciname)),
           pred.changecover = pred.endcover-startcover) %>% 
    mutate(label=spp) %>% 
    mutate(habit.group = case_when(habit=="gram"~"All graminoids",
                                   habit=="forb"&perenneating=="above"~"All above-ground forbs",
                                   habit=="forb"&perenneating=="below"~"All below-ground forbs"))
  pred.df.GDD = rbind(pred.df.GDD,pred.df.spp)
  
}
##### end gdd #####

##### tmean #####
tmeanspp = sig.climVar.REs$species[sig.climVar.REs$term=="max.tmean"]
pred.df.tmean = expand.grid(startcover = startcover.val,
                            min.gdd = median(sppcover.unscaled$min.gdd),
                            min.wy.ppt = median(sppcover.unscaled$min.wy.ppt),
                            max.tmean = seq(min(sppcover.unscaled$max.tmean),max(sppcover.unscaled$max.tmean),length.out=10),
                            min.gs.ppt = median(sppcover.unscaled$min.gs.ppt),
                            habit=c("gram","forb"),
                            sciname="main",
                            perenneating=c("below","above"),
                            latmean1090=median(sppcover.unscaled$latmean1090),
                            sitelat = median(sppcover.unscaled$sitelat)) %>% 
  filter(!(habit=="gram"&perenneating=="above")) %>% 
  mutate(pred.endcover = predict(climVar.mod.us,newdata=.,re.form=NA),
         pred.changecover = pred.endcover-startcover) %>% 
  mutate(label = case_when(habit=="gram"~"All graminoids",
                           habit=="forb"&perenneating=="above"~"All above-ground forbs",
                           habit=="forb"&perenneating=="below"~"All below-ground forbs"),
         habit.group = label)

for(i in 1:length(tmeanspp)){
  
  spp = tmeanspp[i]
  pred.df.spp = expand.grid(startcover = startcover.val,
                            min.gdd = median(sppcover.unscaled$min.gdd),
                            min.wy.ppt = median(sppcover.unscaled$min.wy.ppt),
                            max.tmean = seq(min(sppcover.unscaled$max.tmean),max(sppcover.unscaled$max.tmean),length.out=10),
                            min.gs.ppt = median(sppcover.unscaled$min.gs.ppt),
                            sciname=spp,
                            habit=unique(sppcover.unscaled$habit[sppcover.unscaled$sciname==spp]),
                            perenneating=unique(sppcover.unscaled$perenneating[sppcover.unscaled$sciname==spp]),
                            latmean1090=median(sppcover.unscaled$latmean1090),
                            sitelat = median(sppcover.unscaled$sitelat)) %>% 
    mutate(pred.endcover = predict(climVar.mod.us,newdata=.,re.form=~(max.tmean|sciname)),
           pred.changecover = pred.endcover-startcover) %>% 
    mutate(label=spp) %>% 
    mutate(habit.group = case_when(habit=="gram"~"All graminoids",
                                   habit=="forb"&perenneating=="above"~"All above-ground forbs",
                                   habit=="forb"&perenneating=="below"~"All below-ground forbs"))
  pred.df.tmean = rbind(pred.df.tmean,pred.df.spp)
}
rm(i,spp)
##### end tmean #####

```

### climPC1
```{r fig15_16_17_climPC1}

a.order = filter(pred.df.climPC1,habit.group=="All above-ground forbs") %>% 
  filter(climPC1 == max(climPC1)) %>% arrange(-pred.changecover) 
pc1.agf = ggplot()+
  # habit group line
      geom_line(data=subset(pred.df.climPC1,label=="All above-ground forbs"),
                aes(x=climPC1,y=pred.changecover,color=label),linewidth=all.lw)+
  # species lines
      geom_line(data=subset(pred.df.climPC1,habit.group=="All above-ground forbs"&sciname!="main"),
                aes(x=climPC1,y=pred.changecover,color=label),linewidth=spp.lw,alpha=0.75)+
      theme_classic(base_size=base_size)+
  labs(y="Change in cover")+
      scale_color_manual(values = sigREcolpal, breaks=a.order$label)+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=legend_textsize));pc1.agf
rm(a.order)

b.order = filter(pred.df.climPC1,habit.group=="All below-ground forbs") %>% 
  filter(climPC1 == max(climPC1)) %>% arrange(-pred.changecover) 
pc1.bgf = ggplot()+
      geom_line(data=subset(pred.df.climPC1,label=="All below-ground forbs"),
                aes(x=climPC1,y=pred.changecover,color=label),linewidth=all.lw)+
      geom_line(data=subset(pred.df.climPC1,habit.group=="All below-ground forbs"&sciname!="main"),
                aes(x=climPC1,y=pred.changecover,color=label),linewidth=spp.lw,alpha=0.75)+
      theme_classic(base_size=base_size)+
  labs(y="Change in cover")+
  scale_color_manual(values = sigREcolpal, breaks=b.order$label)+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=legend_textsize));pc1.bgf
rm(b.order)

c.order = filter(pred.df.climPC1,habit.group=="All graminoids") %>% 
  filter(climPC1 == max(climPC1)) %>% arrange(-pred.changecover) 
pc1.gram = ggplot()+
  geom_line(data=subset(pred.df.climPC1,label=="All graminoids"),
                aes(x=climPC1,y=pred.changecover,color=label),linewidth=all.lw)+
  geom_line(data=subset(pred.df.climPC1,habit.group=="All graminoids"&sciname!="main"),
                aes(x=climPC1,y=pred.changecover,color=label),linewidth=spp.lw,alpha=0.95)+
  theme_classic(base_size=base_size)+
  labs(y="Change in cover")+
  scale_color_manual(values = sigREcolpal, breaks=c.order$label)+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=legend_textsize));pc1.gram
rm(c.order)
```

### climPC2
```{r fig15_16_17_climPC2}

a.order = filter(pred.df.climPC2,habit.group=="All above-ground forbs") %>% 
  filter(climPC2 == max(climPC2)) %>% arrange(-pred.changecover) 
pc2.agf = ggplot()+
      geom_line(data=subset(pred.df.climPC2,label=="All above-ground forbs"),
                aes(x=climPC2,y=pred.changecover,color=label),linewidth=all.lw)+
      geom_line(data=subset(pred.df.climPC2,habit.group=="All above-ground forbs"&sciname!="main"),
                aes(x=climPC2,y=pred.changecover,color=label),linewidth=spp.lw,alpha=0.75)+
      theme_classic(base_size=base_size)+
      labs(y="Change in cover")+
      scale_color_manual(values = sigREcolpal, breaks=a.order$label)+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=legend_textsize))
rm(a.order)

b.order = filter(pred.df.climPC2,habit.group=="All below-ground forbs") %>% 
  filter(climPC2 == max(climPC2)) %>% arrange(-pred.changecover) 
pc2.bgf = ggplot()+
      geom_line(data=subset(pred.df.climPC2,label=="All below-ground forbs"),
                aes(x=climPC2,y=pred.changecover,color=label),linewidth=all.lw)+
      geom_line(data=subset(pred.df.climPC2,habit.group=="All below-ground forbs"&sciname!="main"),
                aes(x=climPC2,y=pred.changecover,color=label),linewidth=spp.lw,alpha=0.75)+
      theme_classic(base_size=base_size)+
       labs(y="Change in cover")+
      scale_color_manual(values = sigREcolpal, breaks=b.order$label)+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=legend_textsize))
rm(b.order)

c.order = filter(pred.df.climPC2,habit.group=="All graminoids") %>% 
  filter(climPC2 == max(climPC2)) %>% arrange(-pred.changecover) 
pc2.gram = ggplot()+
      geom_line(data=subset(pred.df.climPC2,label=="All graminoids"),
                aes(x=climPC2,y=pred.changecover,color=label),linewidth=all.lw)+
      geom_line(data=subset(pred.df.climPC2,habit.group=="All graminoids"&sciname!="main"),
                aes(x=climPC2,y=pred.changecover,color=label),linewidth=spp.lw,alpha=0.75)+
      labs(y="Change in cover")+
      theme_classic(base_size=base_size)+
      scale_color_manual(values = sigREcolpal, breaks=c.order$label)+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=legend_textsize))
rm(c.order)

```

### min.wy.ppt
```{r fig15_16_17_min.wy.ppt}

a.order = filter(pred.df.WYppt,habit.group=="All above-ground forbs") %>% 
  filter(min.wy.ppt == max(min.wy.ppt)) %>% arrange(-pred.changecover) 
wy.agf = ggplot()+
      geom_line(data=subset(pred.df.WYppt,label=="All above-ground forbs"),
                aes(x=min.wy.ppt,y=pred.changecover,color=label),linewidth=all.lw)+
      geom_line(data=subset(pred.df.WYppt,habit.group=="All above-ground forbs"&sciname!="main"),
                aes(x=min.wy.ppt,y=pred.changecover,color=label),linewidth=spp.lw,alpha=0.75)+
      theme_classic(base_size=base_size)+
      labs(x = "WY ppt",y="Change in cover")+
      scale_color_manual(values = sigREcolpal, breaks=a.order$label)+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=legend_textsize))
rm(a.order)

b.order = filter(pred.df.WYppt,habit.group=="All below-ground forbs") %>% 
  filter(min.wy.ppt == max(min.wy.ppt)) %>% arrange(-pred.changecover) 
wy.bgf = ggplot()+
      geom_line(data=subset(pred.df.WYppt,label=="All below-ground forbs"),
                aes(x=min.wy.ppt,y=pred.changecover,color=label),linewidth=all.lw)+
      geom_line(data=subset(pred.df.WYppt,habit.group=="All below-ground forbs"&sciname!="main"),
                aes(x=min.wy.ppt,y=pred.changecover,color=label),linewidth=spp.lw,alpha=0.75)+
      theme_classic(base_size=base_size)+
        labs(x = "WY ppt",y="Change in cover")+
      scale_color_manual(values = sigREcolpal, breaks=b.order$label)+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=legend_textsize))
rm(b.order)

c.order = filter(pred.df.WYppt,habit.group=="All graminoids") %>% 
  filter(min.wy.ppt == max(min.wy.ppt)) %>% arrange(-pred.changecover) 
wy.gram = ggplot()+
      geom_line(data=subset(pred.df.WYppt,label=="All graminoids"),
                aes(x=min.wy.ppt,y=pred.changecover,color=label),linewidth=all.lw)+
      geom_line(data=subset(pred.df.WYppt,habit.group=="All graminoids"&sciname!="main"),
                aes(x=min.wy.ppt,y=pred.changecover,color=label),linewidth=spp.lw,alpha=0.75)+
      labs(x="WY ppt", y="Change in cover")+
      theme_classic(base_size=base_size)+
      scale_color_manual(values = sigREcolpal, breaks=c.order$label)+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=legend_textsize))
rm(c.order)

```

### min.gs.ppt
```{r fig15_16_17_min.gs.ppt}

a.order = filter(pred.df.GSppt,habit.group=="All above-ground forbs") %>% 
  filter(min.gs.ppt == max(min.gs.ppt)) %>% arrange(-pred.changecover) 
gs.agf = ggplot()+
      geom_line(data=subset(pred.df.GSppt,label=="All above-ground forbs"),
                aes(x=min.gs.ppt,y=pred.changecover,color=label),linewidth=all.lw)+
      geom_line(data=subset(pred.df.GSppt,habit.group=="All above-ground forbs"&sciname!="main"),
                aes(x=min.gs.ppt,y=pred.changecover,color=label),linewidth=spp.lw,alpha=0.75)+
      theme_classic(base_size=base_size)+
      labs(x = "GS ppt",y="Change in cover")+
      scale_color_manual(values = sigREcolpal, breaks=a.order$label)+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=legend_textsize))
rm(a.order)

b.order = filter(pred.df.GSppt,habit.group=="All below-ground forbs") %>% 
  filter(min.gs.ppt == max(min.gs.ppt)) %>% arrange(-pred.changecover) 
gs.bgf = ggplot()+
      geom_line(data=subset(pred.df.GSppt,label=="All below-ground forbs"),
                aes(x=min.gs.ppt,y=pred.changecover,color=label),linewidth=all.lw)+
      geom_line(data=subset(pred.df.GSppt,habit.group=="All below-ground forbs"&sciname!="main"),
                aes(x=min.gs.ppt,y=pred.changecover,color=label),linewidth=spp.lw,alpha=0.75)+
      theme_classic(base_size=base_size)+
        labs(x = "GS ppt",y="Change in cover")+
      scale_color_manual(values = sigREcolpal, breaks=b.order$label)+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=legend_textsize))
rm(b.order)

c.order = filter(pred.df.GSppt,habit.group=="All graminoids") %>% 
  filter(min.gs.ppt == max(min.gs.ppt)) %>% arrange(-pred.changecover) 
gs.gram = ggplot()+
      geom_line(data=subset(pred.df.GSppt,label=="All graminoids"),
                aes(x=min.gs.ppt,y=pred.changecover,color=label),linewidth=all.lw)+
      geom_line(data=subset(pred.df.GSppt,habit.group=="All graminoids"&sciname!="main"),
                aes(x=min.gs.ppt,y=pred.changecover,color=label),linewidth=spp.lw,alpha=0.75)+
      labs(x="GS ppt", y="Change in cover")+
      theme_classic(base_size=base_size)+
      scale_color_manual(values = sigREcolpal, breaks=c.order$label)+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=legend_textsize))
rm(c.order)
```

### min.GDD
```{r fig15_16_17_min.gdd}
a.order = filter(pred.df.GDD,habit.group=="All above-ground forbs") %>% 
  filter(min.gdd == max(min.gdd)) %>% arrange(-pred.changecover) 
gdd.agf = ggplot()+
      geom_line(data=subset(pred.df.GDD,label=="All above-ground forbs"),
                aes(x=min.gdd,y=pred.changecover,color=label),linewidth=all.lw)+
      geom_line(data=subset(pred.df.GDD,habit.group=="All above-ground forbs"&sciname!="main"),
                aes(x=min.gdd,y=pred.changecover,color=label),linewidth=spp.lw,alpha=0.75)+
      theme_classic(base_size=base_size)+
      labs(x = "GDD",y="Change in cover")+
      scale_color_manual(values = sigREcolpal, breaks=a.order$label)+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=legend_textsize))
rm(a.order)

b.order = filter(pred.df.GDD,habit.group=="All below-ground forbs") %>% 
  filter(min.gdd == max(min.gdd)) %>% arrange(-pred.changecover) 
gdd.bgf = ggplot()+
      geom_line(data=subset(pred.df.GDD,label=="All below-ground forbs"),
                aes(x=min.gdd,y=pred.changecover,color=label),linewidth=all.lw)+
      geom_line(data=subset(pred.df.GDD,habit.group=="All below-ground forbs"&sciname!="main"),
                aes(x=min.gdd,y=pred.changecover,color=label),linewidth=spp.lw,alpha=0.75)+
      theme_classic(base_size=base_size)+
        labs(x = "GDD",y="Change in cover")+
      scale_color_manual(values = sigREcolpal, breaks=b.order$label)+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=legend_textsize))
rm(b.order)

c.order = filter(pred.df.GDD,habit.group=="All graminoids") %>% 
  filter(min.gdd == max(min.gdd)) %>% arrange(-pred.changecover) 
gdd.gram = ggplot()+
      geom_line(data=subset(pred.df.GDD,label=="All graminoids"),
                aes(x=min.gdd,y=pred.changecover,color=label),linewidth=all.lw)+
      geom_line(data=subset(pred.df.GDD,habit.group=="All graminoids"&sciname!="main"),
                aes(x=min.gdd,y=pred.changecover,color=label),linewidth=spp.lw,alpha=0.75)+
      labs(x="GDD", y="Change in cover")+
      theme_classic(base_size=base_size)+
      scale_color_manual(values = sigREcolpal, breaks=c.order$label)+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=legend_textsize))
rm(c.order)

```

### max.tmean
```{r fig15_16_17_max.tmean}
a.order = filter(pred.df.tmean,habit.group=="All above-ground forbs") %>% 
  filter(max.tmean == max(max.tmean)) %>% arrange(-pred.changecover) 
tmn.agf = ggplot()+
      geom_line(data=subset(pred.df.tmean,label=="All above-ground forbs"),
                aes(x=max.tmean,y=pred.changecover,color=label),linewidth=all.lw)+
      geom_line(data=subset(pred.df.tmean,habit.group=="All above-ground forbs"&sciname!="main"),
                aes(x=max.tmean,y=pred.changecover,color=label),linewidth=spp.lw,alpha=0.75)+
      theme_classic(base_size = 14)+
      labs(x = "GS tmean",y="Change in cover")+
      scale_color_manual(values = sigREcolpal, breaks=a.order$label)+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=legend_textsize))
rm(a.order)

b.order = filter(pred.df.tmean,habit.group=="All below-ground forbs") %>% 
  filter(max.tmean == max(max.tmean)) %>% arrange(-pred.changecover) 
tmn.bgf = ggplot()+
      geom_line(data=subset(pred.df.tmean,label=="All below-ground forbs"),
                aes(x=max.tmean,y=pred.changecover,color=label),linewidth=all.lw)+
      geom_line(data=subset(pred.df.tmean,habit.group=="All below-ground forbs"&sciname!="main"),
                aes(x=max.tmean,y=pred.changecover,color=label),linewidth=spp.lw,alpha=0.75)+
      theme_classic(base_size = 14)+
        labs(x = "GS tmean",y="Change in cover")+
      scale_color_manual(values = sigREcolpal, breaks=b.order$label)+
      theme(legend.title = element_blank(),
        legend.text = element_text(size=legend_textsize))+
      guides(color=guide_legend(ncol=2),
             linetype="none");tmn.bgf
rm(b.order)

c.order = filter(pred.df.tmean,habit.group=="All graminoids") %>% 
  filter(max.tmean == max(max.tmean)) %>% arrange(-pred.changecover) 
tmn.gram = ggplot()+
      geom_line(data=subset(pred.df.tmean,label=="All graminoids"),
                aes(x=max.tmean,y=pred.changecover,color=label),linewidth=all.lw)+
      geom_line(data=subset(pred.df.tmean,habit.group=="All graminoids"&sciname!="main"),
                aes(x=max.tmean,y=pred.changecover,color=label),linewidth=spp.lw,alpha=0.75)+
      labs(x="GS tmean",y="Change in cover")+
      theme_classic(base_size = 14)+
      scale_color_manual(values = sigREcolpal, breaks=c.order$label)+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=legend_textsize))
rm(c.order)
```

```{r fig15_16_17_combine}
AGFs = cowplot::plot_grid(pc1.agf,pc2.agf,
                          wy.agf,gs.agf,
                          gdd.agf,tmn.agf,
          ncol=2,align = "v");AGFs
ggsave("Results/FinalFigures/figure15_AGFs.png",dpi = 400,h=9,w=11)

BGFs1 = cowplot::plot_grid(pc1.bgf,pc2.bgf,
                           wy.bgf,gs.bgf,
          ncol=2,align = "v");BGFs1

BGFs2 = cowplot::plot_grid(NULL,tmn.bgf,NULL,
                           ncol=3,rel_widths = c(0.15,0.8,0.15));BGFs2

BGFs3 = cowplot::plot_grid(NULL,gdd.bgf,NULL,
                           ncol=3,rel_widths = c(0.25,0.45,0.25))# ;BGFs3

BGFs = cowplot::plot_grid(BGFs1,NULL,BGFs2,NULL,BGFs3,ncol=1,rel_heights = c(2,0.1,1,0.1,1));BGFs
ggsave("Results/FinalFigures/figure16_BGFs.png",dpi = 400,h=11,w=11.5)


grams = cowplot::plot_grid(pc1.gram,pc2.gram,
                          wy.gram,gs.gram,
                          gdd.gram,tmn.gram,
          ncol=2,align = "v");grams
ggsave("Results/FinalFigures/figure17_grams.png",dpi = 400,h=9,w=11)
```

## Figure 18. Total plant cover clim PC model
```{r fig18_climPCplantcover}
##### Climate PC models
plantCover.climPC.df = broom.mixed::tidy(x = climPC.plantCover.mod.us) %>% 
  filter(effect=="fixed") %>% 
  select(-c(effect,group)) %>% 
  filter(term!="(Intercept)")

plantCover.climPC.df$desc = c("Start cover","climPC1","climPC2","Site latitude","YELL","ROMO","GRSD","PECO","climPC1 x start cover", "climPC2 x start cover", "Site latitude x start cover")

plantCover.climPC.df$desc = factor(plantCover.climPC.df$desc, c("Start cover","climPC1","climPC2","Site latitude","climPC1 x start cover", "climPC2 x start cover", "Site latitude x start cover","YELL","ROMO","GRSD","PECO"))

plantCover.climPC.df.out = plantCover.climPC.df %>% 
  select("Term"=desc,"Estimate"=estimate,"Std. error"=std.error) %>% 
  mutate(Estimate=round(Estimate,2),
         `Std. error` = round(`Std. error`,2))

# climPCtab = gt(plantCover.climPC.df.out) %>% 
#   tab_header(title=md("**Total plant cover**"),
#              subtitle="Climate PC model") %>% 
#   cols_align(Term,align="left") %>% 
#   tab_style(style=cell_text(style="italic"),locations = cells_column_labels()) %>% 
#   opt_row_striping(row_striping = TRUE)
# gtsave(climPCtab,"Results/TotalCoverPlots/climPCmod_table.png")

full = ggplot(plantCover.climPC.df,aes(x=estimate,y=desc,color=estimate>0))+
  geom_vline(xintercept = 0,color="grey70",linetype="dashed")+
  geom_point(size=2)+
  geom_errorbar(aes(xmin=estimate-std.error*1.96,xmax=estimate+std.error*1.96),width=0.25)+
    geom_text(aes(y=desc,label=round(estimate,2)),vjust=-1,fontface="bold")+
  theme_bw(base_size = 14)+
  labs(x = "Estimate", y = "")+
  theme(legend.position = "none")+
  scale_y_discrete(limits=rev(levels(plantCover.climPC.df$desc)),expand=c(0,1))+
  scale_color_manual(values=c("red3","dodgerblue3"));full
# ggsave("Results/TotalCoverPlots/climPCcoefs_full.png",dpi=300,w=9,h=5)


zoom = ggplot(plantCover.climPC.df,aes(x=estimate,y=desc,color=estimate>0))+
  geom_vline(xintercept = 0,color="grey70",linetype="dashed")+
  geom_point(size=2)+
  geom_errorbar(aes(xmin=estimate-std.error*1.96,xmax=estimate+std.error*1.96),width=0.25)+
    geom_text(aes(y=desc,label=round(estimate,2)),vjust=-1,fontface="bold")+
  theme_bw(base_size = 14)+
  labs(x = "Estimate", y = "")+
  theme(legend.position = "none")+
  scale_y_discrete(limits=rev(levels(plantCover.climPC.df$desc)),expand=c(0,1))+
  scale_color_manual(values=c("red3","dodgerblue3"))+
  coord_cartesian(xlim=c(-4,4))
# ggsave("Results/TotalCoverPlots/climPCcoefs_zoom.png",dpi=300,w=9,h=5)

cowplot::plot_grid(full,zoom,ncol=1,labels = c("A","B"))
ggsave("Results/FinalFigures/figure23_totalCover_climPC.png",dpi=400,w=9,h=12)
rm(full,zoom)
```

## Figure 19. Total plant cover clim Var model
```{r figure19_totalcover_climVar}
###
plantCover.climVar.df = broom.mixed::tidy(x = climVar.plantCover.mod.us) %>% 
  filter(effect=="fixed") %>% 
  select(-c(effect,group)) %>% 
  filter(term!="(Intercept)")

plantCover.climVar.df$desc = c("Snow days","GS ppt","WY ppt","YELL","ROMO","GRSD","PECO","Start cover","Snow days x start cover", "GS ppt x start cover", "WY ppt x start cover")

plantCover.climVar.df$desc = factor(plantCover.climVar.df$desc, levels = c("Start cover","Snow days","GS ppt","WY ppt","Snow days x start cover", "GS ppt x start cover", "WY ppt x start cover","YELL","ROMO","GRSD","PECO"))

full = ggplot(plantCover.climVar.df,aes(x=estimate,y=desc,color=estimate>0))+
  geom_vline(xintercept = 0,color="grey70",linetype="dashed")+
  geom_point(size=2)+
  geom_errorbar(aes(xmin=estimate-std.error*1.96,xmax=estimate+std.error*1.96),width=0.25)+
  geom_text(aes(y=desc,label=round(estimate,2)),vjust=-1,fontface="bold")+
  theme_bw(base_size = 14)+
  labs(x = "Estimate", y = "")+
  theme(legend.position = "none",
        legend.title = element_blank())+
  scale_y_discrete(limits=rev(levels(plantCover.climVar.df$desc)),expand=c(0,1))+
  scale_color_manual(values=c("red3","dodgerblue3"));full
# ggsave("Results/TotalCoverPlots/climVarcoefs_full.png",dpi=300,w=9,h=5)

zoom = ggplot(plantCover.climVar.df,aes(x=estimate,y=desc,color=estimate>0))+
  geom_vline(xintercept = 0,color="grey70",linetype="dashed")+
  geom_point(size=2)+
  geom_errorbar(aes(xmin=estimate-std.error*1.96,xmax=estimate+std.error*1.96),width=0.25)+
  geom_text(aes(y=desc,label=round(estimate,2)),vjust=-1,fontface="bold")+
  theme_bw(base_size = 14)+
  labs(x = "Estimate", y = "")+
  theme(legend.position = "none",
        legend.title = element_blank())+
  scale_y_discrete(limits=rev(levels(plantCover.climVar.df$desc)),expand=c(0,1))+
  scale_color_manual(values=c("red3","dodgerblue3"))+
  coord_cartesian(xlim=c(-0.5,0.5));zoom
# ggsave("Results/TotalCoverPlots/climVarcoefs_zoom.png",dpi=300,w=9,h=5)

cowplot::plot_grid(full,zoom,ncol=1,labels = c("A","B"))
ggsave("Results/FinalFigures/figure24_totalCover_climVar.png",dpi=400,w=9,h=12)
# 
# plantCover.climVar.df.out = plantCover.climVar.df %>% 
#   select("Term"=desc,"Estimate"=estimate,"Std. error"=std.error) %>% 
#   mutate(Estimate=round(Estimate,2),
#          `Std. error` = round(`Std. error`,2))
# climVartab = gt(plantCover.climVar.df.out) %>% 
#   tab_header(title=md("**Total plant cover**"),
#              subtitle="Explicit climate variable model") %>% 
#   cols_align(Term,align="left") %>% 
#   tab_style(style=cell_text(style="italic"),locations = cells_column_labels()) %>% 
#   opt_row_striping(row_striping = TRUE)
# climVartab
# gtsave(climVartab,"Results/TotalCoverPlots/climVarmod_table.png")
```

## Figure 20 & 21. SOI overview figure
```{r fig20_21_SOIoverview}
soi = read_csv("./InputData/speciesTraits/important_species_final.csv")[1:5]%>% 
  separate(sciname,c("genus","species"),remove = F)

soi_df = NULL
for(i in 1:nrow(soi)){
  
  if(is.na(soi$species[i])){ 
    
    tmp = filter(sppcover.unscaled,genus==soi$genus[i]) %>% 
      mutate(soi_group = genus) %>% 
      group_by(park2,soi_group) %>% 
      mutate(mean.change = mean(changecover),.groups="drop")
    
  } else {
    tmp = filter(sppcover.unscaled,sciname==soi$sciname[i]) %>% 
      mutate(soi_group = sciname) %>% 
      group_by(park2,soi_group) %>% 
      mutate(mean.change = mean(changecover),.groups="drop")     
    }
  
  soi_df = rbind(soi_df,tmp) %>% unique()
  
}

mean.change = soi_df %>% select(park2,soi_group,mean.change) %>% unique()
ggplot(soi_df,aes(x=changecover,y=soi_group))+
  geom_vline(xintercept = 0,color="grey")+
  geom_point(size=2.5,alpha=0.35,stroke=0)+
  geom_point(data=mean.change,size=4,aes(x=mean.change,y=soi_group,color=mean.change>0),alpha=0.75)+
  facet_wrap(~park2,ncol=5)+
  theme_bw(base_size = 14)+
  labs(x = "Change in cover",color = "Mean change")+
  scale_color_manual(values=c("red","dodgerblue3"),labels=c("Negative","Positive")) +
  theme(panel.grid.major = element_line(linewidth=0.5,color="grey50"),
        axis.title.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "top",
        legend.title.align = ,
        #legend.title = element_blank(),
        plot.title = element_text(hjust=0.51,vjust=-2,size=18))+
  guides(colour = guide_legend(title.position="top", title.hjust = 0.5))+
  scale_y_discrete(limits=rev)
ggsave("Results/FinalFigures/figure25a_parkFacet.png",dpi=400,h=8,w=8)


ggplot(soi_df,aes(x=changecover,y=park2))+
  geom_vline(xintercept = 0,color="grey")+
  geom_point(size=2.5,alpha=0.35,stroke=0)+
  geom_point(data=mean.change,size=4,aes(x=mean.change,y=park2,color=mean.change>0),alpha=0.75)+
  facet_wrap(~soi_group,nrow=7)+
  theme_bw(base_size = 14)+
  labs(x = "Change in cover",color = "Mean change")+
  scale_color_manual(values=c("red","dodgerblue3"),labels=c("Negative","Positive")) +
  scale_y_discrete(limits=rev)+
    theme(panel.grid.major = element_line(linewidth=0.5),
        axis.title.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "top")+
  guides(colour = guide_legend(title.position="top", title.hjust = 0.5))
# cowplot::plot_grid(parks,sois,ncol=1,rel_heights = c(1,2))
ggsave("Results/FinalFigures/figure25b_SOIfacet.png",dpi=400,h=10,w=9)
```

## Figure 22. Change in species abundance
```{r fig33_change_abun}

ggplot(sppcover.unscaled, aes(x=tr.num,y=changecover,fill=park))+
  geom_hline(yintercept = 0,color="grey60",linetype=2)+
  geom_boxplot(outlier.alpha = 0.5,
               outlier.stroke=0,
               outlier.size=2.5)+
  theme_bw(base_size = 14)+
  facet_wrap(~park,scales = "free_x",ncol=5) + 
  scale_fill_manual(values=park.pal)+
  theme(legend.position = "none")+
  labs(x="Transition number",y="Change in cover")
ggsave("Results/FinalFigures/figure22_changesppcover.png",dpi=300,h=5,w=10)
```

## Figure 23. Changes in total plant cover
```{r fig23_changetotalplantcover}
start_plantcover.us = select(plantcover.us,park,summit,aspect,startyear,start.plantCover) %>% 
  rename(year=startyear,cover=start.plantCover)

end_plantcover.us = select(plantcover.us,park,summit,aspect,endyear,end.plantCover) %>% 
  rename(year=endyear,cover=end.plantCover)

raw_plantcover.us = rbind(start_plantcover.us,end_plantcover.us) %>% 
  unique() %>% 
  mutate(year=ifelse(year%in%c(2003,2004),"2003-2004",year))

totalcover <- ggplot(raw_plantcover.us,aes(x=as.factor(year),y=cover,group=year,fill=park))+
  geom_boxplot(outlier.alpha = 0.5,outlier.stroke = 0,outlier.size=2.5)+
  theme_bw(base_size=14)+
  facet_wrap(~park,scales="free_x",ncol=5)+
  scale_fill_manual(values=park.pal)+
  theme(legend.position = "none")+
  labs(x="Year",y="Total vascular plant cover") +
  theme(axis.text.x = element_text(angle=45,hjust=1),
        axis.title.x = element_text(vjust=5))

changetotalcover <- ggplot(plantcover.us, aes(x=tr.num,y=change.cover,fill=park))+
  geom_hline(yintercept = 0,color="grey40",linetype=2)+
  geom_boxplot(outlier.alpha = 0.5,outlier.stroke = 0,outlier.size=2.5)+
  theme_bw(base_size = 14)+
  facet_wrap(~park,scales = "free_x",ncol=5) + 
  scale_fill_manual(values=park.pal)+
  theme(legend.position = "none")+
  labs(x="Transition number",y="Change in total vascular plant cover")

cowplot::plot_grid(totalcover,NULL,changetotalcover,ncol=1,align = "v",axis="tblr",rel_heights = c(1.15,0.05,1))
ggsave("Results/FinalFigures/figure23_totalvasccover.png",h=9,w=10,dpi=400)
rm(end_plantcover.us,start_plantcover.us,raw_plantcover.us,totalcover,changetotalcover)
```

# -------------
## Appendix A. Supplementary Methods

#### Figure 25. Pecos photos - PowerPoint

### Figure 24. Histogram of % cover estimates
```{r cover_histograms}
traits = read_csv("InputData/speciesTraits/allparks_speclist_20220124 traits.csv")
veg = read_csv("InputData/byClaire/all_1x1veg_no0s_2024-04-11.csv") %>% 
  filter(cover>0) %>% 
  group_by(park,summit,aspect,year,sciname) %>% 
  summarise(cover=mean(cover)) %>% 
  merge(.,traits,all=T) %>% 
  # filter(!str_detect(sciname," sp$")) %>% 
  filter(tax_unit!='lichen'&habit!="clubmoss"&habit!="fern")

full_hist = ggplot()+
  geom_histogram(data = veg,aes(x=cover),bins=50,color="black",fill="grey90")+
  theme_bw(base_size=14)+
  scale_x_continuous(expand=c(0.01,0))+
  scale_y_continuous(expand=c(0.01,0))+
  labs(x="% cover estimate",y="Count",title="A. All percent cover estimates >0%")+
  geom_label(aes(label=paste0("Total count = ",prettyNum(nrow(veg),big.mark = ",")),x=44.5,y=1750),size=5)+
  theme(plot.title = element_text(face="bold"))
full_hist  

below5 <- veg %>% filter(cover>0&cover<5)
zoom_hist = ggplot()+
  geom_histogram(data=below5,aes(x=cover),bins=50,color="black",fill="grey90")+
  theme_bw(base_size=14)+
  scale_x_continuous(expand=c(0.01,0))+
  scale_y_continuous(expand=c(0.01,0))+
  labs(x="% cover estimate",y="Count",title="B. Percent cover estimates >0% and <5%")+
  geom_label(aes(label=paste0("Total count = ",prettyNum(nrow(below5),big.mark = ",")),x=4.48,y=475),size=5)+
  theme(plot.title = element_text(face="bold"))
zoom_hist
cowplot::plot_grid(full_hist,zoom_hist,ncol=1)
ggsave("Results/FinalFigures/figure24_coverHists.png",h=10,w=10)

```

### Figure 25. hits vs visual cover
```{r fig25_hitsvcover}

#### Bring in combined veg data from YELL, ROMO, GRSD and PECOS ###
veg_3parks <- read_csv("./InputData/vegetation/NPS_IMD_GLORIA_Vegetation_2287428_DataPackage/NPS_IMD_GLORIA_Vegetation_2287428_Vegetation1x1-dataset.csv") %>% 
  select(park=Park,summit=Summit,year=Year, 
         plot=Plot,aspect=PlotAspect,
         GLORIA_SciName=GLORIA_SciName,cover=VisualCover,hits=NumberHits) %>% 
  separate(GLORIA_SciName,into = c("genus","species")) %>% 
  mutate(species = ifelse(species=="in","sp",species),
         sciname=paste(genus,species)) %>% 
  select(-c(genus,species)) %>% 
  # mutate(plot2 = str_sub(plot,2,3)) %>% 
  select(park,summit,aspect,plot,year,sciname,cover,hits) %>% 
  filter(park!="PEC")

veg_3parks$year[veg_3parks$park=="GSD"&veg_3parks$year==2018]=2015

pec <- read_csv("./InputData/vegetation/PECO_Summary_1x1Vegetation_AllSchema_20220506_Revised.csv") %>% 
  select(park=Park,summit=Summit,year=Year, 
         plot=Plot,aspect=PlotAspect,
         sciname=species_name,cover=VisualCover,hits=NumberHits) %>% 
  separate(sciname,into = c("genus","species")) %>% 
  mutate(sciname=paste(genus,species)) %>% 
  select(-c(genus,species)) %>% 
  # mutate(plot2 = str_sub(plot,2,3)) %>% 
  select(park,summit,aspect,plot,year,sciname,cover,hits) %>% 
  ungroup() %>% 
  filter(!is.na(hits))

cover_df = rbind(veg_3parks,pec) %>% 
  mutate(park2 = case_when(park=="GNP"~"GLAC",
                           park=="YNP"~"YELL",
                           park=="RMN"~"ROMO",
                           park=="GSD"~"GRSD",
                           park=="PEC"~"PECO"))

# ### Start plotting ###
cover_compare = cover_df %>%
  group_by(park,summit,aspect,plot,year,sciname) %>%
  summarise(totalCover=sum(cover,na.rm = T),
            totalHits=sum(hits,na.rm=T),.groups="drop") %>%
  filter(!(park=="GRSD"&year<2015)) %>%
  filter(!(park=="ROMO"&year<2014)) %>%
  na.omit()

cover_corr = cover_compare %>%
  group_by(park,year) %>%
  summarise(cover_corr = cor(totalCover,totalHits))

parks = unique(cover_corr$park)

for(i in parks){
  
  tmp_df = filter(cover_compare,park==i) %>% 
    pivot_wider(id_cols=c(park,summit,aspect,plot,sciname),names_from = year,values_from = c(totalCover,totalHits),values_fill = 0)
  
  assign(paste0(i,"_change"),tmp_df)
  rm(tmp_df)
}
rm(i,parks)
#### GRSD ###
GRSD_change =GRSD_change %>% 
  mutate(change.cover = totalCover_2020-totalCover_2015,
         change.hits = totalHits_2020-totalHits_2015)

GRSD_cor = round(cor(GRSD_change$change.cover,GRSD_change$change.hits),2)

GRSD = ggplot()+
  geom_abline(slope=1,color="grey",linewidth=1.5)+
  geom_point(data=GRSD_change,aes(x=change.cover,y=change.hits)) +
  geom_smooth(method="lm")+
  theme_bw(base_size=14)+
  geom_text(aes(label=paste("Correlation = ",GRSD_cor),x=max(GRSD_change$change.cover)-8,y=min(GRSD_change$change.hits)),
            size=5,color="red")+
  labs(x="Change in visual cover estimate",y="Change in hits",title="GRSD")+
  theme(plot.title = element_text(hjust=0.5,size=16,face="bold"))

#### ROMO ###
ROMO_change =ROMO_change %>% 
  mutate(change.cover = totalCover_2019-totalCover_2014,
         change.hits = totalHits_2019-totalHits_2014)

ROMO_cor = round(cor(ROMO_change$change.cover,ROMO_change$change.hits),2)

ROMO = ggplot()+
  geom_abline(slope=1,color="grey",linewidth=1.5)+
  geom_point(data=ROMO_change,aes(x=change.cover,y=change.hits)) +
  geom_smooth(method="lm")+
  theme_bw(base_size=14)+
  geom_text(aes(label=paste("Correlation = ",ROMO_cor),x=max(ROMO_change$change.cover)-5.5,y=min(ROMO_change$change.hits)),
            size=5,color="red")+
  labs(x="Change in visual cover estimate",y="Change in hits",title="ROMO")+
  theme(plot.title = element_text(hjust=0.5,size=16,face="bold"))

#### PECO ###
PECO_change =PECO_change %>% 
  mutate(change.cover = totalCover_2021-totalCover_2016,
         change.hits = totalHits_2021-totalHits_2016)

PECO_cor = round(cor(PECO_change$change.cover,PECO_change$change.hits),2)

PECO = ggplot()+
  geom_abline(slope=1,color="grey",linewidth=1.5)+
  geom_point(data=PECO_change,aes(x=change.cover,y=change.hits)) +
  geom_smooth(method="lm")+
  theme_bw(base_size=14)+
  geom_text(aes(label=paste("Correlation = ",PECO_cor),x=max(PECO_change$change.cover)-5.5,y=min(PECO_change$change.hits)),
            size=5,color="red")+
  labs(x="Change in visual cover estimate",y="Change in hits",title="PECO")+
  theme(plot.title = element_text(hjust=0.5,size=16,face="bold"))

#### YELL ###
YELL_change = YELL_change %>% 
  mutate(change.cover = totalCover_2016-totalCover_2011,
         change.hits = totalHits_2016-totalHits_2011)

YELL_cor = round(cor(YELL_change$change.cover,YELL_change$change.hits),2)

YELL=ggplot()+
  geom_abline(slope=1,color="grey",linewidth=1.5)+
  geom_point(data=YELL_change,aes(x=change.cover,y=change.hits)) +
  geom_smooth(method="lm")+
  theme_bw(base_size=14)+
  geom_text(aes(label=paste("Correlation = ",YELL_cor),x=max(YELL_change$change.cover)-12,y=min(YELL_change$change.hits)),
            size=5,color="red")+
  labs(x="Change in visual cover estimate",y="Change in hits",title="YELL")+
  theme(plot.title = element_text(hjust=0.5,size=16,face="bold"))

cowplot::plot_grid(YELL,ROMO,GRSD,PECO,ncol=2)
ggsave("Results/FinalFigures/figure25_hitsvcover.png",h=11,w=12,dpi=300)
rm(cover_compare,cover_corr,cover_df,GRSD,PECO,ROMO,YELL,GRSD_change,ROMO_change,PECO_change,YELL_change,ROMO_cor,GRSD_cor,YELL_cor,PECO_cor,veg_3parks)
```

### Figure 26. Climate data gaps
```{r fig26_missingT} 

dailyT <- read_csv("InputData/byClaire/dailyT_alldates.csv") %>% 
  mutate(park2 = case_when(park=="GNP"~"GLAC",
                           park=="YNP"~"YELL",
                           park=="RMN"~"ROMO",
                           park=="GSD"~"GRSD",
                           park=="PEC"~"PECO"),
         park2 = factor(park2,levels=park2.order),
         mo.day = format(date,"%m-%d"),
         season = case_when(mo.day>="12-21"|mo.day<"03-21"~"winter",
                            mo.day>="03-21"|mo.day<"06-21"~"spring",
                            mo.day>="06-21"|mo.day<"09-21"~"summer",
                            mo.day>="09-21"|mo.day<"12-21"~"winter"))
missing <- dailyT %>% 
  mutate(nodata = ifelse(n_obs<20,1,0)) %>% 
  group_by(park2) %>% 
  summarise(p_missing = sum(nodata)/n()*100) %>% 
  mutate(park2 = factor(park2,levels=park2.order))

ggplot(missing,aes(x=park2,y=p_missing,fill=park2))+
  geom_col(color="grey40")+
  scale_fill_manual(values=park.pal)+
  theme_bw(base_size=16)+
  labs(x="Park",y="% days with missing temp data")+
  theme(legend.position = "none",
        axis.title.x = element_text(vjust=-0.1))
ggsave("Results/FinalFigures/figure26_missingT.png",dpi=300,h=6,w=9)
rm(missing,dailyT)
```

# -------------

# Appendix B. 

### Figure 27: random intercept v random slopes
```{r fig27_REslopes_by_ints}
eq.size = 5
base.size = 14
pc1 = ggplot(subset(climPC.REs.wide,grpvar!='transition'),aes(x=intercept,y=climPC1))+
  stat_poly_line() +
  geom_hline(yintercept = 0,col="grey80")+
  geom_vline(xintercept = 0,col="grey80")+
  geom_point(alpha=0.75)+
  stat_poly_eq(use_label(c("eq", "R2")),col="red",size=eq.size,label.x = "right") +
  theme_bw(base_size=base.size)+
  labs(x="Species random intercept estimates",
       y="Clim PC 1~species random slope estimates")

pc2 = ggplot(subset(climPC.REs.wide,grpvar!='transition'),aes(x=intercept,y=climPC2))+
  geom_hline(yintercept = 0,col="grey80")+
  geom_vline(xintercept = 0,col="grey80")+
  geom_point(alpha=0.75)+
  theme_bw(base_size=base.size)+
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")),col="red",size=eq.size,label.x = "right") +
  labs(x="Species random intercept estimates",
       y="Clim PC 2~species random slope estimates")

climVar.plots = climVar.REs.wide %>% filter(grpvar!="transition")
tmean = ggplot(climVar.plots,aes(x=intercept,y=max.tmean))+
  geom_hline(yintercept = 0,col="grey80")+
  geom_vline(xintercept = 0,col="grey80")+
  geom_point(alpha=0.75)+
  theme_bw(base_size=base.size)+
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")),col="red",size=eq.size,label.x = "right") +
  labs(x="Species random intercept estimates",
       y="GS T mean~species random slope estimates")

wyppt = ggplot(climVar.plots,aes(x=intercept,y=min.wy.ppt))+
  geom_hline(yintercept = 0,col="grey80")+
  geom_vline(xintercept = 0,col="grey80")+
  geom_point(alpha=0.75)+
  theme_bw(base_size=base.size)+
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")),col="red",size=eq.size,label.x = "right") +
  labs(x="Species random intercept estimates",
       y=" WY ppt~species random slope estimates")

gsppt = ggplot(climVar.plots,aes(x=intercept,y=min.gs.ppt))+
  geom_hline(yintercept = 0,col="grey80")+
  geom_vline(xintercept = 0,col="grey80")+
  geom_point(alpha=0.75)+
  theme_bw(base_size=base.size)+
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")),col="red",size=eq.size,label.x = "right") +
  labs(x="Species random intercept estimates",
       y=" GS ppt~species random slope estimates")

gdd = ggplot(climVar.plots,aes(x=intercept,y=min.gdd))+
  geom_point()+
  geom_hline(yintercept = 0,col="grey80")+
  geom_vline(xintercept = 0,col="grey80")+
  theme_bw(base_size=base.size)+
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")),col="red",size=eq.size,label.x = "right") +
  labs(x="Species random intercept estimates",
       y=" GDD~species random slope estimates")

cowplot::plot_grid(pc1,pc2,tmean,wyppt,gsppt,gdd,ncol=2)
ggsave("Results/FinalFigures/figure20_REslopesbyints.png",h=13,w=11)
# rm(pc1,pc2,tmean,wyppt,gsppt,gdd)
```


## -------------


## Old report version

## Figure 28. Appendix A
```{r fig28_climvar_cors}

climdf = sppcover.orig %>% 
  filter(abs(changecover)<=10) %>% 
  filter(startcover+endcover!=0) %>% 
  select(gs.tmean=mean.tmean,
         snowdays=mean.snowdays,
         gdd=mean.gdd,
         gs.ppt=mean.gs.ppt,
          wy.ppt=mean.wy.ppt,
         AET=mean.aet,
         PET=mean.pet) %>%
  na.omit()

corrplot(cor(climdf),type="lower",diag=F,
               tl.col = "black",addCoef.col=T)
# Manually saved as 7x7

rm(climdf)
```


### Figure 9. Change cover ~ start cover cats by aspect
```{r DansFigs_8}
sppcover.unscaled$aspect = factor(sppcover.unscaled$aspect,levels=c("N","S","E","W"))
ggplot(sppcover.unscaled,aes(x=startcovcats,y=changecover))+
  geom_hline(yintercept = 0,color="black")+
  stat_boxplot(geom="errorbar")+
  geom_boxplot(fill="grey80",
               outlier.size = 1)+
  #scale_y_continuous(breaks=seq(-15,15,5))+
  theme_bw(base_size = 14)+
  labs(x="Starting cover",y="Change in cover")+
  theme(panel.grid = element_blank(),
        strip.background = element_rect(fill="grey95"),
        strip.text = element_text(face="bold"))+
  facet_wrap(~aspect,ncol=2,scales="free_y")
ggsave("Results/FinalFigures/figure9_boxPlots_aspect.png",h=5.5,w=10,dpi=400)

```

## SCRATCH
### 4/17 presentation figures. 
#### Average model responses
```{r presentation_fig1}

fig1_trs = sppcover.unscaled %>% 
  group_by(sciname) %>% 
  summarise(transitions=n()) %>% 
  arrange(-transitions) 

ggplot(fig1_trs,aes(x=transitions))+
  geom_histogram(color="grey20",fill="grey",binwidth = 2.5)+
  theme_bw(base_size = 20)+
  scale_x_continuous(n.breaks=10,expand=c(0.01,0))+
  scale_y_continuous(expand=c(0.01,0))+
  labs(x="Number of transitions",y="")+
  theme(panel.grid.minor = element_blank(),
        axis.title.y=element_blank())

parks = unique(sppcover.unscaled$park)
fig1.df = NULL
for(p in parks){
  
  tmp = filter(sppcover.orig,park==p) %>%
    drop_na(startcover,climPC1,climPC2,latmax1090,latmin1090,latmean1090,latmedian1090) %>% 
    filter(abs(changecover)<=10) %>% # remove suspiciously large changes as these are likely associated with misIDed spp
    filter(startcover+endcover!=0) %>% 
    select(park,summit,aspect,sciname,startyear,endyear,startcover,endcover) %>% 
    unique()
  
  if(p=="GNP"){tmp$startyear[tmp$startyear==2003]=2004}
  years = unique(c(tmp$startyear,tmp$endyear))
  n.years = length(years)
  
  for(year in years){
    
    if(year!=max(years)){
      
      tmp2 = filter(tmp,startyear==year) %>% 
        select(park,summit,aspect,sciname,cover=startcover,year=startyear) %>% 
        unique()
      
      fig1.df = rbind(fig1.df,tmp2)
      rm(tmp2)
    }else{
      
      tmp2 = filter(tmp,endyear==year) %>% 
        select(park,summit,aspect,sciname,cover=endcover,year=endyear) %>% 
        unique()
      
      fig1.df = rbind(fig1.df,tmp2)
      rm(tmp2)
      
    } # end ifelse 
    
  } # end years
  
  rm(years)
  rm(tmp)
} # end park


fig1.plot.df = fig1.df %>% 
  group_by(sciname) %>% 
  summarize(max.cover = max(cover),
            mean.cover = mean(cover)) 


# df = fig1.plot.df %>% select(-mean.cover) %>% arrange(-max.cover) %>% head(10)


ggplot(fig1.plot.df,aes(x=max.cover))+
  geom_histogram(color="grey20",fill="grey",bins = 40)+
  theme_bw(base_size = 20)+
  scale_x_continuous(n.breaks=10,expand=c(0.01,0))+
  scale_y_continuous(expand=c(0.01,0))+
  labs(x="Maximum cover values",y="")+
  theme(panel.grid.minor = element_blank(),
        axis.title.y = element_blank())

ggplot(fig1.plot.df,aes(x=mean.cover))+
  geom_histogram(color="grey20",fill="grey",bins = 30)+
  theme_bw(base_size = 18)+
  scale_x_continuous(n.breaks=10,expand=c(0.01,0))+
  scale_y_continuous(expand=c(0.01,0))+
  labs(x="Mean cover values")+
  theme(panel.grid.minor = element_blank())

ggplot(filter(fig1.plot.df,mean.cover<=2),aes(x=mean.cover))+
  geom_histogram(color="grey20",fill="grey",bins = 30)+
  theme_bw(base_size = 18)+
  scale_x_continuous(n.breaks=10,expand=c(0.01,0.01))+
  scale_y_continuous(expand=c(0.01,0))+
  labs(x="Mean cover values (cover <= 2%)")+
  theme(panel.grid.minor = element_blank())



```

```{r presentation_fig2}

startcover.range = seq(quantile(sppcover.unscaled$startcover[sppcover.unscaled$startcover>=0],0), quantile(sppcover.unscaled$startcover[sppcover.unscaled$startcover>=0],0.95),length.out=10)

var_pred_df = expand.grid(startcover = startcover.range,
                      latmean1090 = median(sppcover.unscaled$latmean1090),
                      sitelat = median(sppcover.unscaled$sitelat),
                      min.gdd = median(sppcover.unscaled$min.gdd),
                      min.gs.ppt = median(sppcover.unscaled$min.gs.ppt),
                      min.wy.ppt = median(sppcover.unscaled$min.wy.ppt), 
                      max.tmean = median(sppcover.unscaled$max.tmean), 
                      habit=unique(sppcover.unscaled$habit),
                      perenneating = unique(sppcover.unscaled$perenneating)) %>% 
  mutate(pred.endcover=predict(object = climVar.mod.us,newdata=.,re.form=NA),
         pred.changecover = pred.endcover - startcover) %>% 
  filter(perenneating == "below"&habit!="tree")

ggplot()+
  geom_hline(yintercept = 0)+
  geom_point(data=filter(sppcover.unscaled,habit!="tree"&startcover<max(startcover.range)),aes(x=startcover,y=changecover),alpha=0.5)+
  geom_line(data=var_pred_df,aes(x=startcover,y=pred.changecover,color=habit),linewidth=1.5,)+
  theme_bw(base_size = 18) + 
  facet_wrap(~habit,scales="free",labeller=labeller(habit=c("forb"="Forbs","gram"="Graminoids","shrub"="Shrubs")))+
  theme(legend.title = element_blank(),
        legend.position = "none",
        panel.grid.major = element_line(linewidth = 0.5),
        strip.text = element_text(size=16))+
  labs(x="Start cover",y="Change in cover")

ggplot()+
  geom_hline(yintercept = 0)+
  geom_point(data=filter(sppcover.unscaled,habit!="tree"),aes(x=startcover,y=changecover),alpha=0.5)+
  geom_line(data=var_pred_df,aes(x=startcover,y=pred.changecover,color=habit),linewidth=1.5,)+
  theme_bw(base_size = 18) + 
  facet_wrap(~habit,labeller=labeller(habit=c("forb"="Forbs","gram"="Graminoids","shrub"="Shrubs")))+
  theme(legend.title = element_blank(),
        legend.position = "none",
        strip.text = element_text(size=16))+
  coord_cartesian(xlim=c(0,5),ylim=c(-1,1.5))
  labs(x="Start cover",y="Change in cover")

```

