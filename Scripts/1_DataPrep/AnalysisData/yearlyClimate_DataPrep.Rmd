---
author: "Claire Powers"
date: '2024-01-18'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## This file prepares a dataset that contains vegetation (summit-aspect-species level), climate (summit-aspect), spatial rang (species-level), and trait data (species-level) for all transitions:
GNP: 2003/2004 -> 2009 -> 2014 -> 2019 (3 transitions)
RMN: 2010 -> 2014 -> 2019 (2 transitions)
YNP: 2011 -> 2016 (1 transition)
GRSD: 2009 -> 2015 -> 2020 (2 transitions)
PECO: 2016 -> 2021 (1 transition)

yr0: Where this is in column names it refers to the growing season period during year of the first census. For example, if a census was completed in 2003, then the yr0.meanT is the mean temperature for the growing season during the 2003 growing season

climyr0: Where this is in column names it refers to the number of snow days leading up to the growing season of the first census. 

# Packages
```{r packages}
rm(list=ls())

library(tidyverse)
library(reshape2)
library(lubridate)
library(ggfortify)
# library(ggbiplot)

# not_all_na <- function(x) any(!is.na(x))
# not_any_na <- function(x) all(!is.na(x))
# all_zero <- function(x) all(x==0)
```


# Read-in data
```{r data}

parks_ns = c("GNP","YNP","RMN","GSD","PEC")

siteinfo = read_csv("./InputData/siteInfo/summitcoordinates.csv") %>% 
  dplyr::select(park,summit,sitelat=lat,sitelong=long,siteelev=elev) %>% 
  mutate(park = factor(park,levels=parks_ns))

# water balance data
wbdata = read_csv("./InputData/byClaire/dailyWBdata.csv") %>% 
  separate(ID,into=c("s","aspect"),sep = "_",remove = F) %>% 
  select(-s)

# Growing season dates (month-day)
# Growing season dates (month-day)
t.gs.start.date = "07-01"
t.grwszn = seq(as.Date(t.gs.start.date,format='%m-%d'),as.Date("09-25",format='%m-%d'),by="day")
t.grwszn = format(t.grwszn,"%m-%d")

ppt.gs.start.date = "06-01"
ppt.grwszn = seq(as.Date(ppt.gs.start.date,format='%m-%d'),as.Date("09-25",format='%m-%d'),by="day")
ppt.grwszn = format(ppt.grwszn,"%m-%d")
```

# Summarize T data
```{r gs.temp}

gs_temps = NULL

for(park.i in parks_ns){

  if(park.i=="PEC"){
    
    gs_temp <- read_csv("./InputData/byClaire/allparks_dailyT_2022-11-01.csv") %>% 
        filter(park==park.i) %>% 
        mutate(year=year(date), md = as.character(format(date,"%m-%d"))) %>% 
        filter(md%in%t.grwszn) %>% 
        group_by(park,summit,aspect,year) %>% 
        summarize(min.tmean=min(tmean,na.rm=T), # minimum mean growing season temperature
                  mean.tmean=mean(tmean,na.rm=T),
                  max.tmean=max(tmean,na.rm=T),
                  .groups = "drop")
    
  } else {
    
    temp_df = read_csv(paste0("./InputData/byClaire/InterpDailyT/",park.i,"_meandailyT.csv")) 
    
    value_col = which(colnames(temp_df)=="value")
    if(!is_empty(value_col)){colnames(temp_df)[value_col]="tmean"}
    
    gs_temp = temp_df %>% 
      mutate(year = year(date),
             md = format(date,"%m-%d")) %>% 
      filter(md%in%t.grwszn) %>% 
      group_by(park,summit,aspect,year) %>% 
      summarize(min.tmean=min(tmean,na.rm=T), # minimum mean growing season temperature
                mean.tmean=mean(tmean,na.rm=T),
                max.tmean=max(tmean,na.rm=T),
                .groups = "drop")
  
    rm(temp_df)
  }
  gs_temps = rbind(gs_temps,gs_temp)
  rm(gs_temp)
}

```

# Now bring in WB model data
```{r snow_wbmdata}

summits <- unique(siteinfo$summit)
start.h20y = "-10-01"
end.h20y = "-09-30"

wateryear_df = NULL
for(s in summits){
  
  df = filter(gs_temps,summit==s)
  years = unique(df$year)
  
  for(i in 1:length(years)){ # start snow days for transition i loop

    yr_t = years[i]
    yr_tm1 = years[i]-1
    
    wy_seq = seq(as.Date(paste0(yr_tm1,start.h20y)),
                 as.Date(paste0(yr_t,end.h20y)),by="day")
      
      # Filter WB data for current transition time frame
    tmp = wbdata %>% 
      filter(summit==s) %>%
      filter(date%in%wy_seq) %>%
      mutate(wy=yr_t,
             wy.grp=paste0("wy",yr_t))
     
      wateryear_df = rbind(wateryear_df,tmp)
     rm(yr_t,yr_tm1,wy_seq,tmp)
     
  } # end snow days for transition i loop
  
}

gdd_df = NULL
for(s in summits){
  
  df = filter(gs_temps,summit==s)
  years = unique(df$year)
  
  tmp.wbdata = filter(wbdata,summit==s) %>% 
    mutate(year=year(date)) %>% 
    filter(year%in%years) %>% 
    group_by(park,summit,aspect,year) %>% 
    summarize(GDD=sum(GDD>0),.groups="drop")

  gdd_df = rbind(gdd_df,tmp.wbdata)
  rm(df,years,tmp.wbdata)
}

snowdays_df = wateryear_df %>% 
  group_by(park,summit,aspect,wy) %>% 
  summarise(snowdays=sum(PACK>0),.groups="drop") 

wy_ppt_df = wateryear_df %>% 
  group_by(park,summit,aspect,wy) %>% 
  summarise(wy.ppt = sum(ppt),.groups = "drop") 

wy_df = merge(wy_ppt_df,snowdays_df,by=c("park","summit","aspect","wy"),all=T) %>% 
  rename(year=wy)

wy_temp_df = merge(wy_df,gs_temps,by=c("park","summit","aspect","year"),all=T)

wy_temp_gdd_df = merge(wy_temp_df,gdd_df,by=c("park","summit","aspect","year"),all=T)

```

# WB model grw szn data
```{r water_wbmdata}
gs_df = NULL

for(s in summits){
  
  df = filter(gs_temps,summit==s)
  years = unique(df$year)
 
  gs_seq = as.Date(c(outer(years,ppt.grwszn,paste,sep="-")))
      
  # Filter WB data for current transition time frame
  tmp = wbdata %>% 
    filter(summit==s) %>%
    filter(date%in%gs_seq) %>% 
    mutate(year = year(date)) %>% 
    group_by(park,summit,aspect,year) %>% 
    dplyr::summarise(pet = mean(PET),
               aet = mean(AET),
               cwd = pet-aet,
               ppt = sum(ppt,na.rm=T),
               .groups = "drop")
   
    gs_df = rbind(gs_df,tmp)
    rm(df,years,gs_seq,tmp)
     
  # } # end snow days for transition i loop
  
}

all_clim_df = merge(wy_temp_gdd_df,gs_df,by=c("park","summit","aspect","year"),all=T) %>% 
  merge(.,siteinfo,by=c("park","summit"))

write_csv(all_clim_df,"InputData/byClaire/annualClim_for_plots.csv")
```

